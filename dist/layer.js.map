{"version":3,"file":"layer.js","sources":["../src/layer.js"],"sourcesContent":["import './leaflet.js';  // a lightly modified version of Leaflet for use as browser module\nimport './mapml.js';       // modified URI to make the function a property of window scope (possibly a bad thing to do).\n\nexport class MapLayer extends HTMLElement {\n  static get observedAttributes() {\n    return ['src', 'label', 'checked', 'hidden'];\n  }\n  get src() {\n    return this.hasAttribute('src')?this.getAttribute('src'):'';\n  }\n\n  set src(val) {\n    if (val) {\n      this.setAttribute('src', val);\n      if (this._layer) {\n        let oldOpacity = this.opacity;\n        // go through the same sequence as if the layer had been removed from\n        // the DOM and re-attached with a new URL source.\n        this.disconnectedCallback();\n        var base = this.baseURI ? this.baseURI : document.baseURI;\n        this._layer = M.mapMLLayer(val ? (new URL(val, base)).href: null, this);\n        this._layer.on('extentload', this._onLayerExtentLoad, this);\n        this._setUpEvents();\n        if (this.parentNode) {\n          this.connectedCallback();\n        }\n        this.opacity = oldOpacity;\n      }\n    }\n  }\n  get label() {\n    return this.hasAttribute('label')?this.getAttribute('label'):'';\n  }\n  set label(val) {\n    if (val) {\n      this.setAttribute('label',val);\n    }\n  }\n  get checked() {\n    return this.hasAttribute('checked');\n  }\n  \n  set checked(val) {\n    if (val) {\n      this.setAttribute('checked', '');\n    } else {\n      this.removeAttribute('checked');\n    }\n  }\n  \n  get hidden() {\n    return this.hasAttribute('hidden');\n  }\n\n  set hidden(val) {\n    if (val) {\n      this.setAttribute('hidden', '');\n    } else {\n      this.removeAttribute('hidden');\n    }\n  }\n\n  get opacity(){\n    return this._layer._container.style.opacity || this._layer.options.opacity;\n  }\n\n  set opacity(val) {\n    if(+val > 1 || +val < 0) return;\n    this._layer.changeOpacity(val);\n  }\n\n  constructor() {\n    // Always call super first in constructor\n    super();\n  }\n  disconnectedCallback() {\n    //    console.log('Custom map element removed from page.');\n    // if the map-layer node is removed from the dom, the layer should be\n    // removed from the map and the layer control \n\n    // this is moved up here so that the layer control doesn't respond\n    // to the layer being removed with the _onLayerChange execution\n    // that is set up in _attached:\n    if(this.hasAttribute(\"data-moving\")) return;\n    this._removeEvents();\n    if (this._layer._map) {\n      this._layer._map.removeLayer(this._layer);\n    }\n\n    if (this._layerControl && !this.hidden) {\n      this._layerControl.removeLayer(this._layer);\n    }\n  }\n  connectedCallback() {\n    //creates listener that waits for createmap event, this allows for delayed builds of maps\n    //this allows a safeguard for the case where loading a custom TCRS takes longer than loading mapml-viewer.js/web-map.js\n    if(this.hasAttribute(\"data-moving\")) return;\n    this.parentNode.addEventListener('createmap', ()=>{\n      this._ready();\n      // if the map has been attached, set this layer up wrt Leaflet map\n      if (this.parentNode._map) {\n          this._attachedToMap();\n      }\n      if (this._layerControl && !this.hidden) {\n        this._layerControl.addOrUpdateOverlay(this._layer, this.label);\n      }\n    }, {once:true}); //listener stops listening after event occurs once\n    //if map is already created then dispatch createmap event, allowing layer to be built\n    if(this.parentNode._map)this.parentNode.dispatchEvent(new CustomEvent('createmap'));\n  }\n  adoptedCallback() {\n  //    console.log('Custom map element moved to new page.');\n  }\n  attributeChangedCallback(name, oldValue, newValue) {\n    switch(name) {\n      case 'label': \n        if (oldValue !== newValue) {\n          this.dispatchEvent(new CustomEvent('labelchanged', {detail: \n            {target: this}}));\n        }\n      break;\n      case 'checked': \n        if (this._layer) {\n          if (typeof newValue === \"string\") {\n            this.parentElement._map.addLayer(this._layer);\n          } else {\n            this.parentElement._map.removeLayer(this._layer);\n          }\n          this.dispatchEvent(new Event(\"change\", { bubbles: true }));\n        }\n      break;\n    case 'hidden':\n      var map = this.parentElement && this.parentElement._map;\n      if (map && this.parentElement.controls) {\n          if (typeof newValue === \"string\") {\n              if (this._layer) {\n                this.parentElement._layerControl.removeLayer(this._layer);\n              }\n          } else {\n              this._layerControl = this.parentElement._layerControl;\n              this._layerControl.addOrUpdateOverlay(this._layer, this.label);\n              this._validateDisabled();\n          }\n      }\n      break;\n    }\n  }\n  _onLayerExtentLoad(e) {\n    // the mapml document associated to this layer can in theory contain many\n    // link[@rel=legend] elements with different @type or other attributes;\n    // currently only support a single link, don't care about type, lang etc.\n    // TODO: add support for full LayerLegend object, and > one link.\n    if (this._layer._legendUrl) {\n      this.legendLinks = \n        [{ type: 'application/octet-stream',\n           href: this._layer._legendUrl,\n           rel: 'legend',\n           lang: null,\n           hreflang: null,\n           sizes: null }];\n    }\n    if (this._layer._title) {\n      this.label = this._layer._title;\n    }\n    // make sure local content layer has the chance to set its extent properly\n    // which is important for the layer control and the disabled property\n    if (this._layer._map) {\n      this._layer.fire('attached', this._layer);\n    }\n    // TODO ensure the controls in this._layerControl contain 'live' controls\n    // which control the layer, not potentially the previous style / src\n    if (this._layerControl) {\n      this._layerControl.addOrUpdateOverlay(this._layer, this.label);\n    }\n    if (!this._layer.error) {\n      // re-use 'loadedmetadata' event from HTMLMediaElement inteface, applied\n      // to MapML extent as metadata\n      // https://developer.mozilla.org/en-US/docs/Web/API/HTMLMediaElement/loadedmetadata_event\n      this.dispatchEvent(new CustomEvent('loadedmetadata', {detail: \n                {target: this}}));\n    } else {\n      this.dispatchEvent(new CustomEvent('error', {detail: \n                {target: this}}));\n    }\n  }\n  _validateDisabled() {\n    setTimeout(() => {\n      let layer = this._layer, map = layer._map;\n      if (map) {\n        let count = 0, total=0, layerTypes = [\"_staticTileLayer\",\"_imageLayer\",\"_mapmlvectors\",\"_templatedLayer\"];\n        if(layer.validProjection){\n          for(let j = 0 ;j<layerTypes.length;j++){\n            let type = layerTypes[j];\n            if(this.checked && layer[type]){\n              if(type === \"_templatedLayer\"){\n                for(let i =0;i<layer._extent._mapExtents.length;i++){\n                  for(let j = 0; j < layer._extent._mapExtents[i].templatedLayer._templates.length; j++){\n                    if(layer._extent._mapExtents[i].templatedLayer._templates[j].rel ===\"query\") continue;\n                    total++;\n                    layer._extent._mapExtents[i].removeAttribute(\"disabled\");\n                    layer._extent._mapExtents[i].disabled = false;\n                    if(!(layer._extent._mapExtents[i].templatedLayer._templates[j].layer.isVisible)){\n                      count++;\n                      layer._extent._mapExtents[i].setAttribute(\"disabled\", \"\");\n                      layer._extent._mapExtents[i].disabled = true;\n                    }\n                  }  \n                }\n              } else {\n                total++;\n                  if(!(layer[type].isVisible))count++;\n              }\n            }\n          }\n        } else{\n          count = 1;\n          total = 1;\n        }\n\n        if(count === total && count !== 0){\n          this.setAttribute(\"disabled\", \"\"); //set a disabled attribute on the layer element\n          this.disabled = true;\n        } else {\n          //might be better not to disable the layer controls, might want to deselect layer even when its out of bounds\n          this.removeAttribute(\"disabled\");\n          this.disabled = false;\n        }\n        map.fire(\"validate\");\n      }\n    }, 0);\n  }\n  _onLayerChange() {\n    if (this._layer._map) {\n     // can't disable observers, have to set a flag telling it where\n     // the 'event' comes from: either the api or a user click/tap\n     // may not be necessary -> this._apiToggleChecked = false;\n     this.checked = this._layer._map.hasLayer(this._layer);\n    }\n  }\n  _ready() {\n    // the layer might not be attached to a map\n    // so we need a way for non-src based layers to establish what their\n    // zoom range, extent and projection are.  meta elements in content to\n    // allow the author to provide this explicitly are one way, they will\n    // be parsed from the second parameter here\n    // IE 11 did not have a value for this.baseURI for some reason\n    var base = this.baseURI ? this.baseURI : document.baseURI;\n    this._layer = M.mapMLLayer(this.src ? (new URL(this.src, base)).href: null, this, {mapprojection:this.parentElement._map.options.projection});\n    this._layer.on('extentload', this._onLayerExtentLoad, this);\n    this._setUpEvents();\n  }\n  _attachedToMap() {\n    // set i to the position of this layer element in the set of layers\n    var i = 0, position = 1;\n    for (var nodes = this.parentNode.children;i < nodes.length;i++) {\n      if (this.parentNode.children[i].nodeName === \"LAYER-\") {\n        if (this.parentNode.children[i] === this) {\n          position = i + 1;\n        } else if (this.parentNode.children[i]._layer) {\n          this.parentNode.children[i]._layer.setZIndex(i+1);\n        }\n      }\n    }\n    var proj = this.parentNode.projection ? this.parentNode.projection : \"OSMTILE\";\n    L.setOptions(this._layer, {zIndex: position, mapprojection: proj, opacity: window.getComputedStyle(this).opacity});\n    // make sure the Leaflet layer has a reference to the map\n    this._layer._map = this.parentNode._map;\n    // notify the layer that it is attached to a map (layer._map)\n    this._layer.fire('attached');\n\n    if (this.checked) {\n      this._layer.addTo(this._layer._map);\n    }\n    \n    // add the handler which toggles the 'checked' property based on the\n    // user checking/unchecking the layer from the layer control\n    // this must be done *after* the layer is actually added to the map\n    this._layer.on('add remove', this._onLayerChange,  this);\n    this._layer.on('add remove extentload', this._validateDisabled,  this);\n\n    // if controls option is enabled, insert the layer into the overlays array\n    if (this.parentNode._layerControl && !this.hidden) {\n      this._layerControl = this.parentNode._layerControl;\n      this._layerControl.addOrUpdateOverlay(this._layer, this.label);\n    }\n    // toggle the this.disabled attribute depending on whether the layer\n    // is: same prj as map, within view/zoom of map\n    this._layer._map.on('moveend', this._validateDisabled,  this);\n    this._layer._map.on('checkdisabled', this._validateDisabled, this);\n    // this is necessary to get the layer control to compare the layer\n    // extents with the map extent & zoom, but it needs to be rethought TODO\n    // for one thing, layers which are checked by the author before \n    // adding to the map are displayed despite that they are not visible\n    // See issue #26\n    //        this._layer._map.fire('moveend');\n  }\n  _removeEvents() {\n    if (this._layer) {\n      this._layer.off('loadstart', false, this);\n      this._layer.off('changestyle', false, this);\n      this._layer.off('add remove', this._onLayerChange,  this);\n    }\n  }\n  _setUpEvents() {\n    this._layer.on('loadstart', \n        function () {\n            this.dispatchEvent(new CustomEvent('loadstart', {detail: \n              {target: this}}));\n        }, this);      \n    this._layer.on('changestyle',\n        function(e) {\n          this.src = e.src;\n          this.dispatchEvent(new CustomEvent('changestyle', {detail: \n              {target: this}}));\n        },this);\n    this._layer.on('changeprojection',\n        function(e) {\n          this.src = e.href;\n          this.dispatchEvent(new CustomEvent('changeprojection', {detail: \n              {target: this}}));\n        },this);\n  }\n  focus(){\n    if(!this.extent) return;\n    let map = this._layer._map,\n      tL = this.extent.topLeft.pcrs,\n      bR = this.extent.bottomRight.pcrs,\n      layerBounds = L.bounds(L.point(tL.horizontal, tL.vertical), L.point(bR.horizontal, bR.vertical)),\n      center = map.options.crs.unproject(layerBounds.getCenter(true)),\n      newZoom = map.getZoom();\n\n    let maxZoom = this.extent.zoom.maxZoom, minZoom = this.extent.zoom.minZoom;\n\n    let scale = map.options.crs.scale(newZoom),\n      mapCenterTCRS = map.options.crs.transformation.transform(layerBounds.getCenter(true), scale);\n\n    let mapHalf = map.getSize().divideBy(2),\n      mapTlNew = mapCenterTCRS.subtract(mapHalf).round(),\n      mapBrNew = mapCenterTCRS.add(mapHalf).round();\n\n    let mapTlPCRSNew = M.pixelToPCRSPoint(mapTlNew, newZoom, map.options.projection),\n      mapBrPCRSNew = M.pixelToPCRSPoint(mapBrNew, newZoom, map.options.projection);\n\n    let mapPCRS = L.bounds(mapTlPCRSNew, mapBrPCRSNew);\n\n    let zOffset = mapPCRS.contains(layerBounds) ? 1 : -1;\n\n    while((zOffset === -1 && !(mapPCRS.contains(layerBounds)) && (newZoom - 1) >= minZoom)  ||\n          (zOffset === 1 && mapPCRS.contains(layerBounds) && (newZoom + 1) <= maxZoom)) {\n      newZoom += zOffset;\n\n      scale = map.options.crs.scale(newZoom);\n      mapCenterTCRS = map.options.crs.transformation.transform(layerBounds.getCenter(true), scale);\n\n      mapTlNew = mapCenterTCRS.subtract(mapHalf).round();\n      mapBrNew = mapCenterTCRS.add(mapHalf).round();\n      mapTlPCRSNew = M.pixelToPCRSPoint(mapTlNew, newZoom, map.options.projection);\n      mapBrPCRSNew = M.pixelToPCRSPoint(mapBrNew, newZoom, map.options.projection);\n\n      mapPCRS = L.bounds(mapTlPCRSNew, mapBrPCRSNew);\n    }\n    if(zOffset === 1 && newZoom - 1 >= 0) newZoom--;\n    map.setView(center, newZoom, {animate: false});\n  }\n  mapml2geojson(options = {}){\n    return M.mapml2geojson(this, options);\n  }\n}\n"],"names":["MapLayer","HTMLElement","observedAttributes","src","this","hasAttribute","getAttribute","val","oldOpacity","base","setAttribute","_layer","opacity","disconnectedCallback","baseURI","document","M","mapMLLayer","URL","href","on","_onLayerExtentLoad","_setUpEvents","parentNode","connectedCallback","label","checked","removeAttribute","hidden","_container","style","options","changeOpacity","constructor","super","_removeEvents","_map","removeLayer","_layerControl","addEventListener","_ready","_attachedToMap","addOrUpdateOverlay","once","dispatchEvent","CustomEvent","adoptedCallback","attributeChangedCallback","name","oldValue","newValue","detail","target","parentElement","addLayer","Event","bubbles","controls","_validateDisabled","e","_legendUrl","legendLinks","type","rel","lang","hreflang","sizes","_title","fire","error","setTimeout","let","layer","map","count","total","layerTypes","validProjection","j","length","i","_extent","_mapExtents","templatedLayer","_templates","disabled","_onLayerChange","hasLayer","mapprojection","projection","position","nodes","children","nodeName","setZIndex","proj","L","setOptions","zIndex","window","getComputedStyle","addTo","off","focus","extent","tL","topLeft","pcrs","bR","bottomRight","layerBounds","bounds","point","horizontal","vertical","center","crs","unproject","getCenter","newZoom","getZoom","maxZoom","zoom","minZoom","scale","mapCenterTCRS","transformation","transform","mapHalf","getSize","divideBy","mapTlNew","subtract","round","mapBrNew","add","mapTlPCRSNew","pixelToPCRSPoint","mapBrPCRSNew","mapPCRS","zOffset","contains","setView","animate","mapml2geojson"],"mappings":"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"}