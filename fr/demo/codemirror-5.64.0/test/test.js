var Pos=CodeMirror.Pos;function forEach(e,o){for(var t=0,r=e.length;t<r;++t)o(e[t],t)}function addDoc(e,o,t){for(var r=[],s="",a=0;a<o;++a)s+="x";for(a=0;a<t;++a)r.push(s);e.setValue(r.join("\n"))}function byClassName(e,o){if(e.getElementsByClassName)return e.getElementsByClassName(o);var t=[],r=new RegExp("\\b"+o+"\\b");return function e(o){if(3!=o.nodeType){r.test(o.className)&&t.push(o);for(var s=0,a=o.childNodes.length;s<a;++s)e(o.childNodes[s])}}(e),t}CodeMirror.defaults.rtlMoveVisually=!0;var ie_lt8=/MSIE [1-7]\b/.test(navigator.userAgent),ie_lt9=/MSIE [1-8]\b/.test(navigator.userAgent),mac=/Mac/.test(navigator.platform),opera=/Opera\/\./.test(navigator.userAgent),opera_version=opera&&navigator.userAgent.match(/Version\/(\d+\.\d+)/);opera_version&&(opera_version=Number(opera_version));var knownScrollbarWidth,opera_lt10=opera&&(!opera_version||opera_version<10);function foldLines(e,o,t,r){return e.markText(Pos(o,0),Pos(t-1),{inclusiveLeft:!0,inclusiveRight:!0,collapsed:!0,clearOnEnter:r})}function scrollbarWidth(e){if(null!=knownScrollbarWidth)return knownScrollbarWidth;var o=document.createElement("div");return o.style.cssText="width: 50px; height: 50px; overflow-x: scroll",document.body.appendChild(o),knownScrollbarWidth=o.offsetHeight-o.clientHeight,document.body.removeChild(o),knownScrollbarWidth||0}function mouseDown(e,o,t,r){var s=e.charCoords(t,"window"),a={type:"mousedown",preventDefault:Math.min,which:o,target:e.display.lineDiv,clientX:s.left,clientY:s.top};if(r)for(var n in r)a[n]=r[n];e.triggerOnMouseDown(a)}namespace="core_",test("core_fromTextArea",(function(){var e=document.getElementById("code");e.value="CONTENT";var o=CodeMirror.fromTextArea(e);is(!e.offsetHeight),eq(o.getValue(),"CONTENT"),o.setValue("foo\nbar"),eq(o.getValue(),"foo\nbar"),o.save(),is(/^foo\r?\nbar$/.test(e.value)),o.setValue("xxx"),o.toTextArea(),is(e.offsetHeight),eq(e.value,"xxx")})),testCM("getRange",(function(e){eq(e.getLine(0),"1234"),eq(e.getLine(1),"5678"),eq(e.getLine(2),null),eq(e.getLine(-1),null),eq(e.getRange(Pos(0,0),Pos(0,3)),"123"),eq(e.getRange(Pos(0,-1),Pos(0,200)),"1234"),eq(e.getRange(Pos(0,2),Pos(1,2)),"34\n56"),eq(e.getRange(Pos(1,2),Pos(100,0)),"78")}),{value:"1234\n5678"}),testCM("replaceRange",(function(e){eq(e.getValue(),""),e.replaceRange("foo\n",Pos(0,0)),eq(e.getValue(),"foo\n"),e.replaceRange("a\nb",Pos(0,1)),eq(e.getValue(),"fa\nboo\n"),eq(e.lineCount(),3),e.replaceRange("xyzzy",Pos(0,0),Pos(1,1)),eq(e.getValue(),"xyzzyoo\n"),e.replaceRange("abc",Pos(0,0),Pos(10,0)),eq(e.getValue(),"abc"),eq(e.lineCount(),1)})),testCM("selection",(function(e){e.setSelection(Pos(0,4),Pos(2,2)),is(e.somethingSelected()),eq(e.getSelection(),"11\n222222\n33"),eqCursorPos(e.getCursor(!1),Pos(2,2)),eqCursorPos(e.getCursor(!0),Pos(0,4)),e.setSelection(Pos(1,0)),is(!e.somethingSelected()),eq(e.getSelection(),""),eqCursorPos(e.getCursor(!0),Pos(1,0)),e.replaceSelection("abc","around"),eq(e.getSelection(),"abc"),eq(e.getValue(),"111111\nabc222222\n333333"),e.replaceSelection("def","end"),eq(e.getSelection(),""),eqCursorPos(e.getCursor(!0),Pos(1,3)),e.setCursor(Pos(2,1)),eqCursorPos(e.getCursor(!0),Pos(2,1)),e.setCursor(1,2),eqCursorPos(e.getCursor(!0),Pos(1,2))}),{value:"111111\n222222\n333333"}),testCM("extendSelection",(function(e){e.setExtending(!0),addDoc(e,10,10),e.setSelection(Pos(3,5)),eqCursorPos(e.getCursor("head"),Pos(3,5)),eqCursorPos(e.getCursor("anchor"),Pos(3,5)),e.setSelection(Pos(2,5),Pos(5,5)),eqCursorPos(e.getCursor("head"),Pos(5,5)),eqCursorPos(e.getCursor("anchor"),Pos(2,5)),eqCursorPos(e.getCursor("start"),Pos(2,5)),eqCursorPos(e.getCursor("end"),Pos(5,5)),e.setSelection(Pos(5,5),Pos(2,5)),eqCursorPos(e.getCursor("head"),Pos(2,5)),eqCursorPos(e.getCursor("anchor"),Pos(5,5)),eqCursorPos(e.getCursor("start"),Pos(2,5)),eqCursorPos(e.getCursor("end"),Pos(5,5)),e.extendSelection(Pos(3,2)),eqCursorPos(e.getCursor("head"),Pos(3,2)),eqCursorPos(e.getCursor("anchor"),Pos(5,5)),e.extendSelection(Pos(6,2)),eqCursorPos(e.getCursor("head"),Pos(6,2)),eqCursorPos(e.getCursor("anchor"),Pos(5,5)),e.extendSelection(Pos(6,3),Pos(6,4)),eqCursorPos(e.getCursor("head"),Pos(6,4)),eqCursorPos(e.getCursor("anchor"),Pos(5,5)),e.extendSelection(Pos(0,3),Pos(0,4)),eqCursorPos(e.getCursor("head"),Pos(0,3)),eqCursorPos(e.getCursor("anchor"),Pos(5,5)),e.extendSelection(Pos(4,5),Pos(6,5)),eqCursorPos(e.getCursor("head"),Pos(6,5)),eqCursorPos(e.getCursor("anchor"),Pos(4,5)),e.setExtending(!1),e.extendSelection(Pos(0,3),Pos(0,4)),eqCursorPos(e.getCursor("head"),Pos(0,3)),eqCursorPos(e.getCursor("anchor"),Pos(0,4))})),testCM("lines",(function(e){eq(e.getLine(0),"111111"),eq(e.getLine(1),"222222"),eq(e.getLine(-1),null),e.replaceRange("",Pos(1,0),Pos(2,0)),e.replaceRange("abc",Pos(1,0),Pos(1)),eq(e.getValue(),"111111\nabc")}),{value:"111111\n222222\n333333"}),testCM("indent",(function(e){e.indentLine(1),eq(e.getLine(1),"   blah();"),e.setOption("indentUnit",8),e.indentLine(1),eq(e.getLine(1),"\tblah();"),e.setOption("indentUnit",10),e.setOption("tabSize",4),e.indentLine(1),eq(e.getLine(1),"\t\t  blah();")}),{value:"if (x) {\nblah();\n}",indentUnit:3,indentWithTabs:!0,tabSize:8}),testCM("indentByNumber",(function(e){e.indentLine(0,2),eq(e.getLine(0),"  foo"),e.indentLine(0,-200),eq(e.getLine(0),"foo"),e.setSelection(Pos(0,0),Pos(1,2)),e.indentSelection(3),eq(e.getValue(),"   foo\n   bar\nbaz")}),{value:"foo\nbar\nbaz"}),test("core_defaults",(function(){var e={},o=CodeMirror.defaults;for(var t in o)e[t]=o[t];o.indentUnit=5,o.value="uu",o.indentWithTabs=!0,o.tabindex=55;var r=document.getElementById("testground"),s=CodeMirror(r);try{eq(s.getOption("indentUnit"),5),s.setOption("indentUnit",10),eq(o.indentUnit,5),eq(s.getValue(),"uu"),eq(s.getOption("indentWithTabs"),!0),eq(s.getInputField().tabIndex,55)}finally{for(var t in e)o[t]=e[t];r.removeChild(s.getWrapperElement())}})),testCM("lineInfo",(function(e){eq(e.lineInfo(-1),null);var o=document.createElement("span"),t=e.setGutterMarker(1,"FOO",o),r=e.lineInfo(1);eq(r.text,"222222"),eq(r.gutterMarkers.FOO,o),eq(r.line,1),eq(e.lineInfo(2).gutterMarkers,null),e.setGutterMarker(t,"FOO",null),eq(e.lineInfo(1).gutterMarkers,null),e.setGutterMarker(1,"FOO",o),e.setGutterMarker(0,"FOO",o),e.clearGutter("FOO"),eq(e.lineInfo(0).gutterMarkers,null),eq(e.lineInfo(1).gutterMarkers,null)}),{value:"111111\n222222\n333333"}),testCM("coords",(function(e){e.setSize(null,100),addDoc(e,32,200);var o=e.charCoords(Pos(0,0)),t=e.charCoords(Pos(200,30));is(o.left<t.left),is(o.top<t.top),is(o.top<o.bottom),e.scrollTo(null,100);var r=e.charCoords(Pos(0,0));is(o.top>r.top),eq(o.left,r.left)})),testCM("coordsChar",(function(e){addDoc(e,35,70);for(var o=0;o<2;++o)for(var t=o?"local":"page",r=0;r<=35;r+=5)for(var s=0;s<70;s+=5){e.setCursor(s,r);var a=e.charCoords(Pos(s,r),t),n=e.coordsChar({left:a.left+1,top:a.top+1},t);eqCharPos(n,Pos(s,r))}}),{lineNumbers:!0}),testCM("coordsCharBidi",(function(e){addDoc(e,35,70),e.setValue(e.getValue().replace(/\bx/g,"\u0648"));for(var o=0;o<2;++o)for(var t=o?"local":"page",r=2;r<=35;r+=5)for(var s=0;s<70;s+=5){e.setCursor(s,r);var a=e.charCoords(Pos(s,r),t),n=e.coordsChar({left:a.left+1,top:a.top+1},t);eqCharPos(n,Pos(s,r))}}),{lineNumbers:!0}),testCM("badBidiOptimization",(function(e){if(!window.automatedTests){var o=e.charCoords(Pos(0,34));eqCharPos(e.coordsChar({left:o.right,top:o.top+2}),Pos(0,34))}}),{value:'----------<p class="title">\u0647\u0644 \u064a\u0645\u0643\u0646\u0643 \u0627\u062e\u062a\u064a\u0627\u0631 \u0645\u0633\u062a\u0648\u0649 \u0642\u0633\u0637 \u0627\u0644\u062a\u0623\u0645\u064a\u0646 \u0627\u0644\u0630\u064a \u062a\u0631\u063a\u0628 \u0628\u062f\u0641\u0639\u0647\u061f</p>'}),testCM("posFromIndex",(function(e){e.setValue("This function should\nconvert a zero based index\nto line and ch.");for(var o=[{index:-1,line:0,ch:0},{index:0,line:0,ch:0},{index:10,line:0,ch:10},{index:39,line:1,ch:18},{index:55,line:2,ch:7},{index:63,line:2,ch:15},{index:64,line:2,ch:15}],t=0;t<o.length;t++){var r=o[t],s=e.posFromIndex(r.index);eq(s.line,r.line),eq(s.ch,r.ch),r.index>=0&&r.index<64&&eq(e.indexFromPos(s),r.index)}})),testCM("undo",(function(e){e.replaceRange("def",Pos(0,0),Pos(0)),eq(e.historySize().undo,1),e.undo(),eq(e.getValue(),"abc"),eq(e.historySize().undo,0),eq(e.historySize().redo,1),e.redo(),eq(e.getValue(),"def"),eq(e.historySize().undo,1),eq(e.historySize().redo,0),e.setValue("1\n\n\n2"),e.clearHistory(),eq(e.historySize().undo,0);for(var o=0;o<20;++o)e.replaceRange("a",Pos(0,0)),e.replaceRange("b",Pos(3,0));eq(e.historySize().undo,40);for(o=0;o<40;++o)e.undo();eq(e.historySize().redo,40),eq(e.getValue(),"1\n\n\n2")}),{value:"abc"}),testCM("undoDepth",(function(e){e.replaceRange("d",Pos(0)),e.replaceRange("e",Pos(0)),e.replaceRange("f",Pos(0)),e.undo(),e.undo(),e.undo(),eq(e.getValue(),"abcd")}),{value:"abc",undoDepth:4}),testCM("undoDoesntClearValue",(function(e){e.undo(),eq(e.getValue(),"x")}),{value:"x"}),testCM("undoMultiLine",(function(e){e.operation((function(){e.replaceRange("x",Pos(0,0)),e.replaceRange("y",Pos(1,0))})),e.undo(),eq(e.getValue(),"abc\ndef\nghi"),e.operation((function(){e.replaceRange("y",Pos(1,0)),e.replaceRange("x",Pos(0,0))})),e.undo(),eq(e.getValue(),"abc\ndef\nghi"),e.operation((function(){e.replaceRange("y",Pos(2,0)),e.replaceRange("x",Pos(1,0)),e.replaceRange("z",Pos(2,0))})),e.undo(),eq(e.getValue(),"abc\ndef\nghi",3)}),{value:"abc\ndef\nghi"}),testCM("undoComposite",(function(e){e.replaceRange("y",Pos(1)),e.operation((function(){e.replaceRange("x",Pos(0)),e.replaceRange("z",Pos(2))})),eq(e.getValue(),"ax\nby\ncz\n"),e.undo(),eq(e.getValue(),"a\nby\nc\n"),e.undo(),eq(e.getValue(),"a\nb\nc\n"),e.redo(),e.redo(),eq(e.getValue(),"ax\nby\ncz\n")}),{value:"a\nb\nc\n"}),testCM("undoSelection",(function(e){e.setSelection(Pos(0,2),Pos(0,4)),e.replaceSelection(""),e.setCursor(Pos(1,0)),e.undo(),eqCursorPos(e.getCursor(!0),Pos(0,2)),eqCursorPos(e.getCursor(!1),Pos(0,4)),e.setCursor(Pos(1,0)),e.redo(),eqCursorPos(e.getCursor(!0),Pos(0,2)),eqCursorPos(e.getCursor(!1),Pos(0,2))}),{value:"abcdefgh\n"}),testCM("undoSelectionAsBefore",(function(e){e.replaceSelection("abc","around"),e.undo(),e.redo(),eq(e.getSelection(),"abc")})),testCM("selectionChangeConfusesHistory",(function(e){e.replaceSelection("abc",null,"dontmerge"),e.operation((function(){e.setCursor(Pos(0,0)),e.replaceSelection("abc",null,"dontmerge")})),eq(e.historySize().undo,2)})),testCM("markTextSingleLine",(function(e){forEach([{a:0,b:1,c:"",f:2,t:5},{a:0,b:4,c:"",f:0,t:2},{a:1,b:2,c:"x",f:3,t:6},{a:4,b:5,c:"",f:3,t:5},{a:4,b:5,c:"xx",f:3,t:7},{a:2,b:5,c:"",f:2,t:3},{a:2,b:5,c:"abcd",f:6,t:7},{a:2,b:6,c:"x",f:null,t:null},{a:3,b:6,c:"",f:null,t:null},{a:0,b:9,c:"hallo",f:null,t:null},{a:4,b:6,c:"x",f:3,t:4},{a:4,b:8,c:"",f:3,t:4},{a:6,b:6,c:"a",f:3,t:6},{a:8,b:9,c:"",f:3,t:6}],(function(o){e.setValue("1234567890");var t=e.markText(Pos(0,3),Pos(0,6),{className:"foo"});e.replaceRange(o.c,Pos(0,o.a),Pos(0,o.b));var r=t.find();eq(r&&r.from.ch,o.f),eq(r&&r.to.ch,o.t)}))})),testCM("markTextMultiLine",(function(e){function o(e){return e&&Pos(e[0],e[1])}forEach([{a:[0,0],b:[0,5],c:"",f:[0,0],t:[2,5]},{a:[0,0],b:[0,5],c:"foo\n",f:[1,0],t:[3,5]},{a:[0,1],b:[0,10],c:"",f:[0,1],t:[2,5]},{a:[0,5],b:[0,6],c:"x",f:[0,6],t:[2,5]},{a:[0,0],b:[1,0],c:"",f:[0,0],t:[1,5]},{a:[0,6],b:[2,4],c:"",f:[0,5],t:[0,7]},{a:[0,6],b:[2,4],c:"aa",f:[0,5],t:[0,9]},{a:[1,2],b:[1,8],c:"",f:[0,5],t:[2,5]},{a:[0,5],b:[2,5],c:"xx",f:null,t:null},{a:[0,0],b:[2,10],c:"x",f:null,t:null},{a:[1,5],b:[2,5],c:"",f:[0,5],t:[1,5]},{a:[2,0],b:[2,3],c:"",f:[0,5],t:[2,2]},{a:[2,5],b:[3,0],c:"a\nb",f:[0,5],t:[2,5]},{a:[2,3],b:[3,0],c:"x",f:[0,5],t:[2,3]},{a:[1,1],b:[1,9],c:"1\n2\n3",f:[0,5],t:[4,5]}],(function(t){e.setValue("aaaaaaaaaa\nbbbbbbbbbb\ncccccccccc\ndddddddd\n");var r=e.markText(Pos(0,5),Pos(2,5),{className:"CodeMirror-matchingbracket"});e.replaceRange(t.c,o(t.a),o(t.b));var s=r.find();eqCursorPos(s&&s.from,o(t.f)),eqCursorPos(s&&s.to,o(t.t))}))})),testCM("markTextUndo",(function(e){var o,t,r;o=e.markText(Pos(0,1),Pos(0,3),{className:"CodeMirror-matchingbracket"}),t=e.markText(Pos(0,0),Pos(2,1),{className:"CodeMirror-matchingbracket"}),r=e.setBookmark(Pos(1,5)),e.operation((function(){e.replaceRange("foo",Pos(0,2)),e.replaceRange("bar\nbaz\nbug\n",Pos(2,0),Pos(3,0))}));var s=e.getValue();e.setValue(""),eq(o.find(),null),eq(t.find(),null),eq(r.find(),null),e.undo(),eqCursorPos(r.find(),Pos(1,5),"still there"),e.undo();var a=o.find(),n=t.find();eqCursorPos(a.from,Pos(0,1)),eqCursorPos(a.to,Pos(0,3)),eqCursorPos(n.from,Pos(0,0)),eqCursorPos(n.to,Pos(2,1)),eqCursorPos(r.find(),Pos(1,5)),e.redo(),e.redo(),eq(r.find(),null),e.undo(),eqCursorPos(r.find(),Pos(1,5)),eq(e.getValue(),s)}),{value:"1234\n56789\n00\n"}),testCM("markTextStayGone",(function(e){var o=e.markText(Pos(0,0),Pos(0,1));e.replaceRange("hi",Pos(0,2)),o.clear(),e.undo(),eq(o.find(),null)}),{value:"hello"}),testCM("markTextAllowEmpty",(function(e){var o=e.markText(Pos(0,1),Pos(0,2),{clearWhenEmpty:!1});is(o.find()),e.replaceRange("x",Pos(0,0)),is(o.find()),e.replaceRange("y",Pos(0,2)),is(o.find()),e.replaceRange("z",Pos(0,3),Pos(0,4)),is(!o.find());var t=e.markText(Pos(0,1),Pos(0,2),{clearWhenEmpty:!1,inclusiveLeft:!0,inclusiveRight:!0});e.replaceRange("q",Pos(0,1),Pos(0,2)),is(t.find()),e.replaceRange("",Pos(0,0),Pos(0,3)),is(!t.find());var r=e.markText(Pos(0,1),Pos(0,1),{clearWhenEmpty:!1});e.replaceRange("a",Pos(0,3)),is(r.find()),e.replaceRange("b",Pos(0,1)),is(!r.find())}),{value:"abcde"}),testCM("markTextStacked",(function(e){var o=e.markText(Pos(0,0),Pos(0,0),{clearWhenEmpty:!1}),t=e.markText(Pos(0,0),Pos(0,0),{clearWhenEmpty:!1});e.replaceRange("B",Pos(0,1)),is(o.find()&&t.find())}),{value:"A"}),testCM("undoPreservesNewMarks",(function(e){e.markText(Pos(0,3),Pos(0,4)),e.markText(Pos(1,1),Pos(1,3)),e.replaceRange("",Pos(0,3),Pos(3,1));var o=e.markText(Pos(0,0),Pos(0,1)),t=e.markText(Pos(0,5),Pos(0,6)),r=e.markText(Pos(0,2),Pos(0,4));e.undo(),eqCursorPos(o.find().from,Pos(0,0)),eqCursorPos(o.find().to,Pos(0,1)),eqCursorPos(t.find().from,Pos(3,3)),eqCursorPos(t.find().to,Pos(3,4)),eqCursorPos(r.find().from,Pos(0,2)),eqCursorPos(r.find().to,Pos(3,2));var s=e.findMarksAt(Pos(2,2));eq(s.length,1),eq(s[0],r)}),{value:"aaaa\nbbbb\ncccc\ndddd"}),testCM("markClearBetween",(function(e){e.setValue("aaa\nbbb\nccc\nddd\n"),e.markText(Pos(0,0),Pos(2)),e.replaceRange("aaa\nbbb\nccc",Pos(0,0),Pos(2)),eq(e.findMarksAt(Pos(1,1)).length,0)})),testCM("findMarksMiddle",(function(e){var o=e.markText(Pos(1,1),Pos(3,1)),t=e.findMarks(Pos(2,1),Pos(2,2));eq(t.length,1),eq(t[0],o)}),{value:"line 0\nline 1\nline 2\nline 3"}),testCM("deleteSpanCollapsedInclusiveLeft",(function(e){var o=Pos(1,0),t=Pos(1,1);e.markText(o,t,{collapsed:!0,inclusiveLeft:!0});e.replaceRange("",o,t)}),{value:"abc\nX\ndef"}),testCM("markTextCSS",(function(e){function o(){for(var o=e.display.lineDiv.getElementsByTagName("span"),t=0;t<o.length;t++)if(o[t].style.color&&"cdef"==o[t].textContent)return!0}var t=e.markText(Pos(0,2),Pos(0,6),{css:"color: cyan"});is(o()),t.clear(),is(!o())}),{value:"abcdefgh"}),testCM("markTextWithAttributes",(function(e){function o(){for(var o=e.display.lineDiv.getElementsByTagName("span"),t=0;t<o.length;t++)if("label"==o[t].getAttribute("label")&&"cdef"==o[t].textContent)return!0}var t=e.markText(Pos(0,2),Pos(0,6),{attributes:{label:"label"}});is(o()),t.clear(),is(!o())}),{value:"abcdefgh"}),testCM("bookmark",(function(e){function o(e){return e&&Pos(e[0],e[1])}forEach([{a:[1,0],b:[1,1],c:"",d:[1,4]},{a:[1,1],b:[1,1],c:"xx",d:[1,7]},{a:[1,4],b:[1,5],c:"ab",d:[1,6]},{a:[1,4],b:[1,6],c:"",d:null},{a:[1,5],b:[1,6],c:"abc",d:[1,5]},{a:[1,6],b:[1,8],c:"",d:[1,5]},{a:[1,4],b:[1,4],c:"\n\n",d:[3,1]},{bm:[1,9],a:[1,1],b:[1,1],c:"\n",d:[2,8]}],(function(t){e.setValue("1234567890\n1234567890\n1234567890");var r=e.setBookmark(o(t.bm)||Pos(1,5));e.replaceRange(t.c,o(t.a),o(t.b)),eqCursorPos(r.find(),o(t.d))}))})),testCM("bookmarkInsertLeft",(function(e){var o=e.setBookmark(Pos(0,2),{insertLeft:!1}),t=e.setBookmark(Pos(0,2),{insertLeft:!0});e.setCursor(Pos(0,2)),e.replaceSelection("hi"),eqCursorPos(o.find(),Pos(0,2)),eqCursorPos(t.find(),Pos(0,4)),e.replaceRange("",Pos(0,4),Pos(0,5)),e.replaceRange("",Pos(0,2),Pos(0,4)),e.replaceRange("",Pos(0,1),Pos(0,2)),eqCursorPos(o.find(),Pos(0,1)),eqCursorPos(t.find(),Pos(0,1))}),{value:"abcdef"}),testCM("bookmarkCursor",(function(e){var o=e.cursorCoords(Pos(0,1)),t=e.cursorCoords(Pos(1,1)),r=e.cursorCoords(Pos(2,0)),s=e.cursorCoords(Pos(3,0)),a=e.cursorCoords(Pos(4,1));e.setBookmark(Pos(0,1),{widget:document.createTextNode("\u2190"),insertLeft:!0}),e.setBookmark(Pos(2,0),{widget:document.createTextNode("\u2190"),insertLeft:!0}),e.setBookmark(Pos(1,1),{widget:document.createTextNode("\u2192")}),e.setBookmark(Pos(3,0),{widget:document.createTextNode("\u2192")});var n=e.cursorCoords(Pos(0,1)),i=e.cursorCoords(Pos(1,1)),u=e.cursorCoords(Pos(2,0)),l=e.cursorCoords(Pos(3,0));near(n.left,o.left,1),near(n.top,o.top,1),is(i.left>t.left,"at right, middle of line"),near(i.top==t.top,1),near(u.left,r.left,1),near(u.top,r.top,1),is(l.left>s.left,"at right, empty line"),near(l.top,s,1),e.setBookmark(Pos(4,0),{widget:document.createTextNode("\u2192")}),is(e.cursorCoords(Pos(4,1)).left>a.left,"single-char bug")}),{value:"foo\nbar\n\n\nx\ny"}),testCM("multiBookmarkCursor",(function(e){var o,t=[];function r(o){for(var r=0;r<3;++r){var s=document.createElement("span");s.innerHTML="X",t.push(e.setBookmark(Pos(0,1),{widget:s,insertLeft:o}))}}var s=e.cursorCoords(Pos(0,1)).left,a=e.cursorCoords(Pos(0,4)).left;for(r(!0),near(s,e.cursorCoords(Pos(0,1)).left,1);o=t.pop();)o.clear();r(!1),near(a,e.cursorCoords(Pos(0,1)).left,1)}),{value:"abcdefg"}),testCM("getAllMarks",(function(e){addDoc(e,10,10);var o=e.setBookmark(Pos(0,2)),t=(e.markText(Pos(0,2),Pos(3,2)),e.markText(Pos(1,2),Pos(1,8)));e.markText(Pos(8,0),Pos(9,0));eq(e.getAllMarks().length,4),o.clear(),t.clear(),eq(e.getAllMarks().length,2)})),testCM("setValueClears",(function(e){e.addLineClass(0,"wrap","foo");var o=e.markText(Pos(0,0),Pos(1,1),{inclusiveLeft:!0,inclusiveRight:!0});e.setValue("foo"),is(!e.lineInfo(0).wrapClass),is(!o.find())}),{value:"a\nb"}),testCM("bug577",(function(e){e.setValue("a\nb"),e.clearHistory(),e.setValue("fooooo"),e.undo()})),testCM("scrollSnap",(function(e){e.setSize(100,100),addDoc(e,200,200),e.setCursor(Pos(100,180));var o=e.getScrollInfo();is(o.left>0&&o.top>0),e.setCursor(Pos(0,0)),o=e.getScrollInfo(),is(0==o.left&&0==o.top,"scrolled clean to top"),e.setCursor(Pos(100,180)),e.setCursor(Pos(199,0)),o=e.getScrollInfo(),is(0==o.left&&o.top+2>o.height-e.getScrollerElement().clientHeight,"scrolled clean to bottom")})),testCM("scrollIntoView",(function(e){function o(o,t,r){var s=Pos(o,t);e.scrollIntoView(s);var a=e.getWrapperElement().getBoundingClientRect(),n=e.charCoords(s,"window");is(n.left>=a.left,r+" (left)"),is(n.right<=a.right,r+" (right)"),is(n.top>=a.top,r+" (top)"),is(n.bottom<=a.bottom,r+" (bottom)")}addDoc(e,200,200),o(199,199,"bottom right"),o(0,0,"top left"),o(100,100,"center"),o(199,0,"bottom left"),o(0,199,"top right"),o(100,100,"center again")})),testCM("scrollBackAndForth",(function(e){addDoc(e,1,200),e.operation((function(){e.scrollIntoView(Pos(199,0)),e.scrollIntoView(Pos(4,0))})),is(e.getScrollInfo().top>0)})),testCM("selectAllNoScroll",(function(e){addDoc(e,1,200),e.execCommand("selectAll"),eq(e.getScrollInfo().top,0),e.setCursor(199),e.execCommand("selectAll"),is(e.getScrollInfo().top>0)})),testCM("selectionPos",(function(e){if("textarea"==e.getOption("inputStyle")){e.setSize(100,100),addDoc(e,200,100),e.setSelection(Pos(1,100),Pos(98,100));var o=e.charCoords(Pos(0,200),"local").left,t=(e.charCoords(Pos(99)).top-e.charCoords(Pos(0)).top)/100;e.scrollTo(0,0);for(var r,s,a,n=byClassName(e.getWrapperElement(),"CodeMirror-selected"),i=e.getWrapperElement().getBoundingClientRect(),u=0,l=n.length;u<l;++u){var c=n[u].getBoundingClientRect(),d=c.left-i.left<30,C=c.right-c.left,g=c.right-i.left>.8*o;d&&g?(r=!0,is(c.bottom-c.top>90*t,"middle high"),is(C>.9*o,"middle wide")):(is(C>.4*o,"top/bot wide enough"),is(C<.6*o,"top/bot slim enough"),d?(a=!0,is(c.top-i.top>96*t,"bot below")):g&&(s=!0,is(c.top-i.top<2.1*t,"top above")))}is(s&&a&&r,"all parts")}}),null),testCM("restoreHistory",(function(e){e.setValue("abc\ndef"),e.replaceRange("hello",Pos(1,0),Pos(1)),e.replaceRange("goop",Pos(0,0),Pos(0)),e.undo();var o=e.getValue(),t=e.getHistory();window.JSON&&(t=JSON.parse(JSON.stringify(t))),eq(o,"abc\nhello"),e.setValue(""),e.clearHistory(),eq(e.historySize().undo,0),e.setValue(o),e.setHistory(t),e.redo(),eq(e.getValue(),"goop\nhello"),e.undo(),e.undo(),eq(e.getValue(),"abc\ndef")})),testCM("doubleScrollbar",(function(e){var o=document.body.appendChild(document.createElement("p"));o.style.cssText="height: 50px; overflow: scroll; width: 50px";var t=o.offsetWidth+1-o.clientWidth;if(document.body.removeChild(o),!(t<2)){e.setSize(null,100),addDoc(e,1,300);var r=e.getWrapperElement();is(r.offsetWidth-byClassName(r,"CodeMirror-lines")[0].offsetWidth<=1.5*t)}})),testCM("weirdLinebreaks",(function(e){e.setValue("foo\nbar\rbaz\r\nquux\n\rplop"),is(e.getValue(),"foo\nbar\nbaz\nquux\n\nplop"),is(e.lineCount(),6),e.setValue("\n\n"),is(e.lineCount(),3)})),testCM("setSize",(function(e){e.setSize(100,100);var o=e.getWrapperElement();is(o.offsetWidth,100),is(o.offsetHeight,100),e.setSize("100%","3em"),is(o.style.width,"100%"),is(o.style.height,"3em"),e.setSize(null,40),is(o.style.width,"100%"),is(o.style.height,"40px")})),testCM("collapsedLines",(function(e){addDoc(e,4,10);var o=foldLines(e,4,5),t=0;CodeMirror.on(o,"clear",(function(){t++})),e.setCursor(Pos(3,0)),CodeMirror.commands.goLineDown(e),eqCharPos(e.getCursor(),Pos(5,0)),e.replaceRange("abcdefg",Pos(3,0),Pos(3)),e.setCursor(Pos(3,6)),CodeMirror.commands.goLineDown(e),eqCharPos(e.getCursor(),Pos(5,4)),e.replaceRange("ab",Pos(3,0),Pos(3)),e.setCursor(Pos(3,2)),CodeMirror.commands.goLineDown(e),eqCharPos(e.getCursor(),Pos(5,2)),e.operation((function(){o.clear(),o.clear()})),eq(t,1)})),testCM("collapsedRangeCoordsChar",(function(e){var o=e.charCoords(Pos(1,3));o.left+=2,o.top+=2;var t={collapsed:!0,inclusiveLeft:!0,inclusiveRight:!0},r=e.markText(Pos(0,0),Pos(2,0),t);eqCharPos(e.coordsChar(o),Pos(3,3)),r.clear();r=e.markText(Pos(0,0),Pos(1,1),{collapsed:!0,inclusiveLeft:!0});var s=e.markText(Pos(1,1),Pos(2,0),{collapsed:!0,inclusiveRight:!0});eqCharPos(e.coordsChar(o),Pos(3,3)),r.clear(),s.clear();r=e.markText(Pos(0,0),Pos(1,6),t);eqCharPos(e.coordsChar(o),Pos(3,3))}),{value:"123456\nabcdef\nghijkl\nmnopqr\n"}),testCM("collapsedRangeBetweenLinesSelected",(function(e){if("textarea"==e.getOption("inputStyle")){var o=document.createElement("span");o.textContent="\u2194",e.markText(Pos(0,3),Pos(1,0),{replacedWith:o}),e.setSelection(Pos(0,3),Pos(1,0));for(var t=byClassName(e.getWrapperElement(),"CodeMirror-selected"),r=0,s=0;r<t.length;r++)s+=t[r].offsetWidth;is(s>0)}}),{value:"one\ntwo"}),testCM("randomCollapsedRanges",(function(e){addDoc(e,20,500),e.operation((function(){for(var o=0;o<200;o++){var t=Pos(Math.floor(500*Math.random()),Math.floor(20*Math.random()));if(o%4)try{e.markText(t,Pos(t.line+2,1),{collapsed:!0})}catch(r){if(!/overlapping/.test(String(r)))throw r}else e.markText(t,Pos(t.line,t.ch+4),{className:"foo"})}}))})),testCM("hiddenLinesAutoUnfold",(function(e){var o=foldLines(e,1,3,!0),t=0;CodeMirror.on(o,"clear",(function(){t++})),e.setCursor(Pos(3,0)),eq(t,0),e.execCommand("goCharLeft"),eq(t,1),o=foldLines(e,1,3,!0),CodeMirror.on(o,"clear",(function(){t++})),eqCursorPos(e.getCursor(),Pos(3,0)),e.setCursor(Pos(0,3)),e.execCommand("goCharRight"),eq(t,2)}),{value:"abc\ndef\nghi\njkl"}),testCM("hiddenLinesSelectAll",(function(e){addDoc(e,4,20),foldLines(e,0,10),foldLines(e,11,20),CodeMirror.commands.selectAll(e),eqCursorPos(e.getCursor(!0),Pos(10,0)),eqCursorPos(e.getCursor(!1),Pos(10,4))})),testCM("clickFold",(function(e){e.setValue("foo { bar }");var o=document.createElement("span");o.textContent="<>",e.markText(Pos(0,5),Pos(0,10),{replacedWith:o});var t=e.charCoords(Pos(0,10)),r=e.coordsChar({left:t.left-1,top:t.top+4});is(r.ch<=5||r.ch>=10,"Position is not inside the folded range")})),testCM("everythingFolded",(function(e){function o(){e.triggerOnKeyDown({type:"keydown",keyCode:13,preventDefault:function(){},stopPropagation:function(){}})}addDoc(e,2,2);var t=foldLines(e,0,2);o(),eq(e.getValue(),"xx\nxx"),t.clear(),t=foldLines(e,0,2,!0),eq(t.find(),null),o(),eq(e.getValue(),"\nxx\nxx")})),testCM("structuredFold",(function(e){addDoc(e,4,8);var o=e.markText(Pos(1,2),Pos(6,2),{replacedWith:document.createTextNode("Q")});e.setCursor(0,3),CodeMirror.commands.goLineDown(e),eqCharPos(e.getCursor(),Pos(6,2)),CodeMirror.commands.goCharLeft(e),eqCharPos(e.getCursor(),Pos(1,2)),CodeMirror.commands.delCharAfter(e),eq(e.getValue(),"xxxx\nxxxx\nxxxx"),addDoc(e,4,8),o=e.markText(Pos(1,2),Pos(6,2),{replacedWith:document.createTextNode("M"),clearOnEnter:!0});var t=0;CodeMirror.on(o,"clear",(function(){++t})),e.setCursor(0,3),CodeMirror.commands.goLineDown(e),eqCharPos(e.getCursor(),Pos(6,2)),CodeMirror.commands.goCharLeft(e),eqCharPos(e.getCursor(),Pos(6,1)),eq(t,1),o.clear(),eq(t,1),(o=e.markText(Pos(1,2),Pos(6,2),{replacedWith:document.createTextNode("Q"),clearOnEnter:!0})).clear(),e.setCursor(1,2),CodeMirror.commands.goCharRight(e),eqCharPos(e.getCursor(),Pos(1,3)),o=e.markText(Pos(2,0),Pos(4,4),{replacedWith:document.createTextNode("M")}),e.setCursor(1,0),CodeMirror.commands.goLineDown(e),eqCharPos(e.getCursor(),Pos(2,0))}),null),testCM("nestedFold",(function(e){function o(o,t,r,s){return e.markText(Pos(o,t),Pos(r,s),{collapsed:!0})}addDoc(e,10,3);o(0,6,1,3);var t=o(0,2,1,8),r=o(0,1,2,3),s=o(0,5,0,6);e.setCursor(0,1),CodeMirror.commands.goCharRight(e),eqCursorPos(e.getCursor(),Pos(2,3)),s.clear(),CodeMirror.commands.goCharLeft(e),eqCursorPos(e.getCursor(),Pos(0,1)),r.clear(),CodeMirror.commands.goCharRight(e),eqCursorPos(e.getCursor(),Pos(0,2,"before")),CodeMirror.commands.goCharRight(e),eqCursorPos(e.getCursor(),Pos(1,8)),t.clear(),CodeMirror.commands.goCharLeft(e),eqCursorPos(e.getCursor(),Pos(1,7,"after")),e.setCursor(0,5),CodeMirror.commands.goCharRight(e),eqCursorPos(e.getCursor(),Pos(0,6,"before")),CodeMirror.commands.goCharRight(e),eqCursorPos(e.getCursor(),Pos(1,3))})),testCM("badNestedFold",(function(e){var o;addDoc(e,4,4),e.markText(Pos(0,2),Pos(3,2),{collapsed:!0});try{e.markText(Pos(0,1),Pos(0,3),{collapsed:!0})}catch(t){o=t}is(o instanceof Error,"no error"),is(/overlap/i.test(o.message),"wrong error")})),testCM("nestedFoldOnSide",(function(e){var o=e.markText(Pos(0,1),Pos(2,1),{collapsed:!0,inclusiveRight:!0});e.markText(Pos(0,1),Pos(0,2),{collapsed:!0});e.markText(Pos(0,1),Pos(0,2),{collapsed:!0}).clear();try{e.markText(Pos(0,1),Pos(0,2),{collapsed:!0,inclusiveLeft:!0})}catch(s){var t=s}is(t&&/overlap/i.test(t.message));e.markText(Pos(2,0),Pos(2,1),{collapsed:!0});var r=e.markText(Pos(2,0),Pos(2,1),{collapse:!0,inclusiveRight:!0});o.clear(),r.clear(),o=e.markText(Pos(0,1),Pos(2,1),{collapsed:!0}),e.markText(Pos(2,0),Pos(2,1),{collapsed:!0}).clear();try{e.markText(Pos(2,0),Pos(2,1),{collapsed:!0,inclusiveRight:!0})}catch(s){t=s}is(t&&/overlap/i.test(t.message))}),{value:"ab\ncdef"}),testCM("editInFold",(function(e){addDoc(e,4,6);e.markText(Pos(1,2),Pos(3,2),{collapsed:!0});e.replaceRange("",Pos(0,0),Pos(1,3)),e.replaceRange("",Pos(2,1),Pos(3,3)),e.replaceRange("a\nb\nc\nd",Pos(0,1),Pos(1,0)),e.cursorCoords(Pos(0,0))})),testCM("wrappingInlineWidget",(function(e){e.setSize("11em");var o=document.createElement("span");o.style.color="red",o.innerHTML="one two three four",e.markText(Pos(0,6),Pos(0,9),{replacedWith:o});var t=e.cursorCoords(Pos(0,0)),r=e.cursorCoords(Pos(0,10));is(t.top<r.top),is(t.bottom<r.bottom);var s=e.cursorCoords(Pos(0,6)),a=e.cursorCoords(Pos(0,9));eq(s.top,t.top),eq(s.bottom,t.bottom),eq(a.top,r.top),eq(a.bottom,r.bottom),e.replaceRange("",Pos(0,9),Pos(0)),a=e.cursorCoords(Pos(0,9)),eq(a.top,r.top),eq(a.bottom,r.bottom)}),{value:"1 2 3 xxx 4",lineWrapping:!0}),testCM("showEmptyWidgetSpan",(function(e){e.markText(Pos(0,2),Pos(0,2),{clearWhenEmpty:!1,replacedWith:document.createTextNode("X")});var o=e.display.view[0].text;eq(o.textContent||o.innerText,"abXc")}),{value:"abc"}),testCM("changedInlineWidget",(function(e){e.setSize("10em");var o=document.createElement("span");o.innerHTML="x";var t=e.markText(Pos(0,4),Pos(0,5),{replacedWith:o});o.innerHTML="and now the widget is really really long all of a sudden and a scrollbar is needed",t.changed();var r=byClassName(e.getWrapperElement(),"CodeMirror-hscrollbar")[0];is(r.scrollWidth>r.clientWidth)}),{value:"hello there"}),testCM("changedBookmark",(function(e){e.setSize("10em");var o=document.createElement("span");o.innerHTML="x";var t=e.setBookmark(Pos(0,4),{widget:o});o.innerHTML="and now the widget is really really long all of a sudden and a scrollbar is needed",t.changed();var r=byClassName(e.getWrapperElement(),"CodeMirror-hscrollbar")[0];is(r.scrollWidth>r.clientWidth)}),{value:"abcdefg"}),testCM("inlineWidget",(function(e){var o=e.setBookmark(Pos(0,2),{widget:document.createTextNode("uu")});e.setCursor(0,2),CodeMirror.commands.goLineDown(e),eqCharPos(e.getCursor(),Pos(1,4)),e.setCursor(0,2),e.replaceSelection("hi"),eqCharPos(o.find(),Pos(0,2)),e.setCursor(0,1),e.replaceSelection("ay"),eqCharPos(o.find(),Pos(0,4)),eq(e.getLine(0),"uayuhiuu")}),{value:"uuuu\nuuuuuu"}),testCM("wrappingAndResizing",(function(e){e.setSize(null,"auto"),e.setOption("lineWrapping",!0);var o=e.getWrapperElement(),t=o.offsetHeight,r="xxx xxx xxx xxx xxx";e.setValue(r);for(var s=10,a=e.charCoords(Pos(0,18),"div").right;;a+=s)if(e.setSize(a),o.offsetHeight<=t*(opera_lt10?1.2:1.5)){if(10!=s)break;a-=10,s=1}e.setCursor(Pos(0,19)),eq(o.offsetHeight,t),e.replaceSelection("x"),is(o.offsetHeight>t,"wrapping happens"),e.setValue(r+"\n"+r+"\n"),e.getScrollerElement().style.maxHeight="100px",e.replaceRange("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n!\n",Pos(2,0)),forEach([Pos(0,19),Pos(0,18),Pos(0,0),Pos(1,19),Pos(1,18)],(function(o){var t=e.charCoords(o);eqCharPos(o,e.coordsChar({left:t.left+2,top:t.top+5}))}))}),null,ie_lt8),testCM("measureEndOfLine",(function(e){e.setSize(null,"auto");for(var o=byClassName(e.getWrapperElement(),"CodeMirror-lines")[0].firstChild,t=o.offsetHeight,r=10,s=e.charCoords(Pos(0,7),"div").right;;s+=r)if(e.setSize(s),o.offsetHeight<2.5*t){if(10!=r)break;s-=10,r=1}e.setValue(e.getValue()+"\n\n");var a=e.charCoords(Pos(0,18),"local");is(a.top>.8*t,"not at top"),is(a.left>s-20,"at right"),a=e.charCoords(Pos(0,18)),eqCursorPos(e.coordsChar({left:a.left,top:a.top+5}),Pos(0,18,"before"));var n=e.cursorCoords(Pos(0,9,"before"));is(n.top<a.top,"wrapPos is actually in first line"),eqCursorPos(e.coordsChar({left:n.left+10,top:n.top}),Pos(0,9,"before"))}),{mode:"text/html",value:"\x3c!-- foo barrr --\x3e",lineWrapping:!0},ie_lt8||opera_lt10),testCM("measureWrappedEndOfLine",(function(e){e.setSize(null,"auto");for(var o=byClassName(e.getWrapperElement(),"CodeMirror-lines")[0].firstChild,t=o.offsetHeight,r=10,s=e.charCoords(Pos(0,7),"div").right;;s+=r)if(e.setSize(s),o.offsetHeight<2.5*t){if(10!=r)break;s-=10,r=1}for(var a=0;a<3;++a){var n=e.charCoords(Pos(0,12));if(n.left+=s,eqCursorPos(e.coordsChar(n),Pos(0,13,"before")),n.left+=100*s,eqCursorPos(e.coordsChar(n),Pos(0,13,"before")),e.setValue("0123456789abc\u0627\u0628\u062c\u0627\u0628\u062c\u0627\u0628\u062c\u0627\u0628\u062c"),1==a){var i=document.createElement("div");i.innerHTML="hi",i.style.height="30px",e.addLineWidget(0,i,{above:!0})}}}),{mode:"text/html",value:"0123456789abcde0123456789",lineWrapping:!0},ie_lt8||opera_lt10),testCM("measureEndOfLineBidi",(function(e){eqCursorPos(e.coordsChar({left:5e3,top:e.charCoords(Pos(0,0)).top}),Pos(0,8,"after"))}),{value:"\u0625\u0625\u0625\u0625uuuu\u0625\u0625\u0625\u0625"}),testCM("measureWrappedBidiLevel2",(function(e){e.setSize(e.charCoords(Pos(0,6),"editor").right+60);var o=e.charCoords(Pos(0,9));eqCharPos(e.coordsChar({left:o.right-1,top:o.top+1}),Pos(0,9))}),{value:"foobar \u0625\u0625 \u0625\u0625 \u0625\u0625 \u0625\u0625 555 \u0628\u0628\u0628\u0628\u0628\u0628",lineWrapping:!0}),testCM("measureWrappedBeginOfLine",(function(e){e.setSize(null,"auto");for(var o=byClassName(e.getWrapperElement(),"CodeMirror-lines")[0].firstChild,t=o.offsetHeight,r=10,s=e.charCoords(Pos(0,7),"div").right;;s+=r)if(e.setSize(s),o.offsetHeight<2.5*t){if(10!=r)break;s-=10,r=1}for(var a=Pos(0,13,"after"),n=0;n<2;++n){var i=e.charCoords(Pos(0,0));i.left-=s,eqCursorPos(e.coordsChar(i),Pos(0,0,"after")),(i=e.cursorCoords(a)).left=0,eqCursorPos(e.coordsChar(i),a),e.setValue("0123456789abc\u0627\u0628\u062c\u0627\u0628\u062c\u0627\u0628\u062c\u0627\u0628\u062c"),a=Pos(0,25,"before")}}),{mode:"text/html",value:"0123456789abcde0123456789",lineWrapping:!0}),testCM("scrollVerticallyAndHorizontally",(function(e){if("textarea"==e.getOption("inputStyle")){e.setSize(100,100),addDoc(e,40,40),e.setCursor(39);var o=e.getWrapperElement(),t=byClassName(o,"CodeMirror-vscrollbar")[0];is(t.offsetHeight<o.offsetHeight,"vertical scrollbar limited by horizontal one");var r=byClassName(o,"CodeMirror-cursor")[0].getBoundingClientRect(),s=o.getBoundingClientRect();is(r.bottom<s.top+e.getScrollerElement().clientHeight,"bottom line visible")}}),{lineNumbers:!0}),testCM("moveVstuck",(function(e){var o=byClassName(e.getWrapperElement(),"CodeMirror-lines")[0].firstChild,t=o.offsetHeight,r="fooooooooooooooooooooooooo baaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaar\n";e.setValue(r);for(var s=2.8*e.charCoords(Pos(0,26),"div").right;e.setSize(s),!(o.offsetHeight<=3.5*t);s+=5);e.setCursor(Pos(0,104)),e.moveV(-1,"line"),eqCursorPos(e.getCursor(),Pos(0,27,"before")),is(e.cursorCoords(null,"local").top<t,"cursor is in first visual line")}),{lineWrapping:!0},ie_lt8||opera_lt10),testCM("collapseOnMove",(function(e){e.setSelection(Pos(0,1),Pos(2,4)),e.execCommand("goLineUp"),is(!e.somethingSelected()),eqCharPos(e.getCursor(),Pos(0,1)),e.setSelection(Pos(0,1),Pos(2,4)),e.execCommand("goPageDown"),is(!e.somethingSelected()),eqCharPos(e.getCursor(),Pos(2,4)),e.execCommand("goLineUp"),e.execCommand("goLineUp"),eqCharPos(e.getCursor(),Pos(0,4)),e.setSelection(Pos(0,1),Pos(2,4)),e.execCommand("goCharLeft"),is(!e.somethingSelected()),eqCharPos(e.getCursor(),Pos(0,1))}),{value:"aaaaa\nb\nccccc"}),testCM("clickTab",(function(e){var o=e.charCoords(Pos(0,0));eqCharPos(e.coordsChar({left:o.left+5,top:o.top+5}),Pos(0,0)),eqCharPos(e.coordsChar({left:o.right-5,top:o.top+5}),Pos(0,1))}),{value:"\t\n\n",lineWrapping:!0,tabSize:8}),testCM("verticalScroll",(function(e){e.setSize(100,200),e.setValue("foo\nbar\nbaz\n");var o=e.getScrollerElement(),t=o.scrollWidth;e.replaceRange("aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaah",Pos(0,0),Pos(0)),is(o.scrollWidth>t,"scrollbar present"),e.replaceRange("foo",Pos(0,0),Pos(0)),eq(o.scrollWidth,t,"scrollbar gone"),e.replaceRange("aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaah",Pos(0,0),Pos(0)),e.replaceRange("bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbh",Pos(1,0),Pos(1)),is(o.scrollWidth>t,"present again");var r=o.scrollWidth;e.replaceRange("foo",Pos(0,0),Pos(0)),is(o.scrollWidth<r,"scrollbar smaller"),is(o.scrollWidth>t,"but still present")})),testCM("extraKeys",(function(e){var o;function t(t,r,s){"string"==typeof r&&(r=r.charCodeAt(0));var a={type:"keydown",keyCode:r,preventDefault:function(){},stopPropagation:function(){}};if(s)for(var n in s)a[n]=s[n];o=null,e.triggerOnKeyDown(a),eq(o,t)}CodeMirror.commands.testCommand=function(){o="tc"},CodeMirror.commands.goTestCommand=function(){o="gtc"},e.setOption("extraKeys",{"Shift-X":function(){o="sx"},X:function(){o="x"},"Ctrl-Alt-U":function(){o="cau"},End:"testCommand",Home:"goTestCommand",Tab:!1}),t(null,"U"),t("cau","U",{ctrlKey:!0,altKey:!0}),t(null,"U",{shiftKey:!0,ctrlKey:!0,altKey:!0}),t("x","X"),t("sx","X",{shiftKey:!0}),t("tc",35),t(null,35,{shiftKey:!0}),t("gtc",36),t("gtc",36,{shiftKey:!0}),t(null,9)}),null,window.opera&&mac),testCM("wordMovementCommands",(function(e){e.execCommand("goWordLeft"),eqCursorPos(e.getCursor(),Pos(0,0)),e.execCommand("goWordRight"),e.execCommand("goWordRight"),eqCursorPos(e.getCursor(),Pos(0,7,"before")),e.execCommand("goWordLeft"),eqCursorPos(e.getCursor(),Pos(0,5,"after")),e.execCommand("goWordRight"),e.execCommand("goWordRight"),eqCursorPos(e.getCursor(),Pos(0,12,"before")),e.execCommand("goWordLeft"),eqCursorPos(e.getCursor(),Pos(0,9,"after")),e.execCommand("goWordRight"),e.execCommand("goWordRight"),e.execCommand("goWordRight"),eqCursorPos(e.getCursor(),Pos(0,24,"before")),e.execCommand("goWordRight"),e.execCommand("goWordRight"),eqCursorPos(e.getCursor(),Pos(1,9,"before")),e.execCommand("goWordRight"),eqCursorPos(e.getCursor(),Pos(1,13,"before")),e.execCommand("goWordRight"),e.execCommand("goWordRight"),eqCharPos(e.getCursor(),Pos(2,0))}),{value:"this is (the) firstline.\na foo12\xe9\xf8\xd7bar\n"}),testCM("groupMovementCommands",(function(e){e.execCommand("goGroupLeft"),eqCursorPos(e.getCursor(),Pos(0,0)),e.execCommand("goGroupRight"),eqCursorPos(e.getCursor(),Pos(0,4,"before")),e.execCommand("goGroupRight"),eqCursorPos(e.getCursor(),Pos(0,7,"before")),e.execCommand("goGroupRight"),eqCursorPos(e.getCursor(),Pos(0,10,"before")),e.execCommand("goGroupLeft"),eqCursorPos(e.getCursor(),Pos(0,7,"after")),e.execCommand("goGroupRight"),e.execCommand("goGroupRight"),e.execCommand("goGroupRight"),eqCursorPos(e.getCursor(),Pos(0,15,"before")),e.setCursor(Pos(0,17)),e.execCommand("goGroupLeft"),eqCursorPos(e.getCursor(),Pos(0,16,"after")),e.execCommand("goGroupLeft"),eqCursorPos(e.getCursor(),Pos(0,14,"after")),e.execCommand("goGroupRight"),e.execCommand("goGroupRight"),eqCursorPos(e.getCursor(),Pos(0,20,"before")),e.execCommand("goGroupRight"),eqCursorPos(e.getCursor(),Pos(1,0,"after")),e.execCommand("goGroupRight"),eqCursorPos(e.getCursor(),Pos(1,2,"before")),e.execCommand("goGroupRight"),eqCursorPos(e.getCursor(),Pos(1,5,"before")),e.execCommand("goGroupLeft"),e.execCommand("goGroupLeft"),eqCursorPos(e.getCursor(),Pos(1,0,"after")),e.execCommand("goGroupLeft"),eqCursorPos(e.getCursor(),Pos(0,20,"after")),e.execCommand("goGroupLeft"),eqCursorPos(e.getCursor(),Pos(0,16,"after"))}),{value:"booo ba---quux. ffff\n  abc d"}),testCM("groupsAndWhitespace",(function(e){for(var o=[Pos(0,0),Pos(0,2),Pos(0,5),Pos(0,9),Pos(0,11),Pos(1,0),Pos(1,2),Pos(1,5)],t=1;t<o.length;t++)e.execCommand("goGroupRight"),eqCharPos(e.getCursor(),o[t]);for(t=o.length-2;t>=0;t--)e.execCommand("goGroupLeft"),eqCharPos(e.getCursor(),2==t?Pos(0,6,"before"):o[t])}),{value:"  foo +++  \n  bar"}),testCM("charMovementCommands",(function(e){e.execCommand("goCharLeft"),e.execCommand("goColumnLeft"),eqCursorPos(e.getCursor(),Pos(0,0)),e.execCommand("goCharRight"),e.execCommand("goCharRight"),eqCursorPos(e.getCursor(),Pos(0,2,"before")),e.setCursor(Pos(1,0)),e.execCommand("goColumnLeft"),eqCursorPos(e.getCursor(),Pos(1,0)),e.execCommand("goCharLeft"),eqCursorPos(e.getCursor(),Pos(0,5,"before")),e.execCommand("goColumnRight"),eqCursorPos(e.getCursor(),Pos(0,5,"before")),e.execCommand("goCharRight"),eqCursorPos(e.getCursor(),Pos(1,0,"after")),e.execCommand("goLineEnd"),eqCursorPos(e.getCursor(),Pos(1,5,"before")),e.execCommand("goLineStartSmart"),eqCursorPos(e.getCursor(),Pos(1,1,"after")),e.execCommand("goLineStartSmart"),eqCursorPos(e.getCursor(),Pos(1,0,"after")),e.setCursor(Pos(2,0)),e.execCommand("goCharRight"),e.execCommand("goColumnRight"),eqCursorPos(e.getCursor(),Pos(2,0))}),{value:"line1\n ine2\n"}),testCM("verticalMovementCommands",(function(e){e.execCommand("goLineUp"),eqCharPos(e.getCursor(),Pos(0,0)),e.execCommand("goLineDown"),eqCharPos(e.getCursor(),Pos(1,0)),e.setCursor(Pos(1,12)),e.execCommand("goLineDown"),eqCharPos(e.getCursor(),Pos(2,5)),e.execCommand("goLineDown"),eqCharPos(e.getCursor(),Pos(3,0)),e.execCommand("goLineUp"),eqCharPos(e.getCursor(),Pos(2,5)),e.execCommand("goLineUp"),eqCharPos(e.getCursor(),Pos(1,12)),e.execCommand("goPageDown"),eqCharPos(e.getCursor(),Pos(5,0)),e.execCommand("goPageDown"),e.execCommand("goLineDown"),eqCharPos(e.getCursor(),Pos(5,0)),e.execCommand("goPageUp"),eqCharPos(e.getCursor(),Pos(0,0))}),{value:"line1\nlong long line2\nline3\n\nline5\n"}),testCM("verticalMovementCommandsWrapping",(function(e){e.setSize(120),e.setCursor(Pos(0,5)),e.execCommand("goLineDown"),eq(e.getCursor().line,0),is(e.getCursor().ch>5,"moved beyond wrap");for(var o=0;;++o){is(o<20,"no endless loop"),e.execCommand("goLineDown");var t=e.getCursor();if(1==t.line&&eq(t.ch,5),2==t.line){eq(t.ch,1);break}}}),{value:"a very long line that wraps around somehow so that we can test cursor movement\nshortone\nk",lineWrapping:!0}),testCM("verticalMovementCommandsSingleLine",(function(e){e.display.wrapper.style.height="auto",e.refresh(),e.execCommand("goLineUp"),eqCursorPos(e.getCursor(),Pos(0,0)),e.execCommand("goLineDown"),eqCursorPos(e.getCursor(),Pos(0,11)),e.setCursor(Pos(0,5)),e.execCommand("goLineDown"),eqCursorPos(e.getCursor(),Pos(0,11)),e.execCommand("goLineDown"),eqCursorPos(e.getCursor(),Pos(0,11)),e.execCommand("goLineUp"),eqCursorPos(e.getCursor(),Pos(0,0)),e.execCommand("goLineUp"),eqCursorPos(e.getCursor(),Pos(0,0)),e.execCommand("goPageDown"),eqCursorPos(e.getCursor(),Pos(0,11)),e.execCommand("goPageDown"),e.execCommand("goLineDown"),eqCursorPos(e.getCursor(),Pos(0,11)),e.execCommand("goPageUp"),eqCursorPos(e.getCursor(),Pos(0,0)),e.setCursor(Pos(0,5)),e.execCommand("goPageUp"),eqCursorPos(e.getCursor(),Pos(0,0)),e.setCursor(Pos(0,5)),e.execCommand("goPageDown"),eqCursorPos(e.getCursor(),Pos(0,11))}),{value:"single line"}),testCM("rtlMovement",(function(e){"textarea"==e.getOption("inputStyle")&&forEach(["\u062e\u062d\u062c","\u062e\u062dabc\u062e\u062d\u062c","ab\u062e\u062d\u062e\u062d\u062ccd","ab\u062ede","ab\u062e\u062d2342\u062e1\u062d\u062c","\u062e1\u062d2\u062e\u062d3\u062dx\u062c","\u062e\u062dcd","1\u062e\u062dcd","abcde\u062d1\u062c","\u062e\u0645\u0631\u062d\u0628\u0647\u0627 \u0645\u0647\u0627!","foobar\u0631","\u062e \u0629 \u0642",'<img src="/\u05d1\u05d3\u05d9\u05e7\u05d43.jpg">',"\u064a\u062a\u0645 \u0627\u0644\u0633\u062d\u0628 \u0641\u064a 05 \u0641\u0628\u0631\u0627\u064a\u0631 2014"],(function(o){e.setValue(o+"\n"),e.execCommand("goLineStart");for(var t=byClassName(e.getWrapperElement(),"CodeMirror-cursors")[0],r=t.firstChild,s=r.offsetLeft,a=r.offsetTop,n=0;n<=o.length;++n)e.execCommand("goCharRight"),r=t.firstChild,n==o.length?is(r.offsetTop>a,"next line"):is(r.offsetLeft>s,"moved right"),s=r.offsetLeft,a=r.offsetTop;e.setCursor(0,0),e.execCommand("goLineEnd"),s=t.firstChild.offsetLeft;for(n=0;n<o.length;++n)e.execCommand("goCharLeft"),r=t.firstChild,is(r.offsetLeft<s,"moved left"),s=r.offsetLeft}))}),null,ie_lt9),testCM("bidiUpdate",(function(e){e.setCursor(Pos(0,2,"before")),e.replaceSelection("\u062e\u062d\u062c","start"),e.execCommand("goCharRight"),eqCursorPos(e.getCursor(),Pos(0,6,"before"))}),{value:"abcd\n"}),testCM("movebyTextUnit",(function(e){e.setValue("\u05d1\u05b0\u05bc\u05e8\u05b5\u05d0\u05e9\u05b4\ne\u0301e\u0301e\u0301\u0301\n"),e.execCommand("goLineStart");for(var o=0;o<4;++o)e.execCommand("goCharRight");eqCursorPos(e.getCursor(),Pos(0,0,"after")),e.execCommand("goCharRight"),eqCursorPos(e.getCursor(),Pos(1,0,"after")),e.execCommand("goCharRight"),e.execCommand("goCharRight"),eqCursorPos(e.getCursor(),Pos(1,4,"before")),e.execCommand("goCharRight"),eqCursorPos(e.getCursor(),Pos(1,7,"before"))})),testCM("lineChangeEvents",(function(e){addDoc(e,3,5);for(var o=[],t=["ch 0","ch 1","del 2","ch 0","ch 0","del 1","del 3","del 4"],r=0;r<5;++r)CodeMirror.on(e.getLineHandle(r),"delete",function(e){return function(){o.push("del "+e)}}(r)),CodeMirror.on(e.getLineHandle(r),"change",function(e){return function(){o.push("ch "+e)}}(r));e.replaceRange("x",Pos(0,1)),e.replaceRange("xy",Pos(1,1),Pos(2)),e.replaceRange("foo\nbar",Pos(0,1)),e.replaceRange("",Pos(0,0),Pos(e.lineCount())),eq(o.length,t.length,"same length");for(r=0;r<o.length;++r)eq(o[r],t[r])})),testCM("scrollEntirelyToRight",(function(e){if("textarea"==e.getOption("inputStyle")){addDoc(e,500,2),e.setCursor(Pos(0,500));var o=e.getWrapperElement(),t=byClassName(o,"CodeMirror-cursor")[0];is(o.getBoundingClientRect().right>t.getBoundingClientRect().left)}})),testCM("lineWidgets",(function(e){addDoc(e,500,3);var o=e.charCoords(Pos(2,0)),t=document.createElement("div");t.innerHTML="hi";e.addLineWidget(1,t);is(o.top<e.charCoords(Pos(2,0)).top,"took up space"),e.setCursor(Pos(1,1)),e.execCommand("goLineDown"),eqCharPos(e.getCursor(),Pos(2,1)),e.execCommand("goLineUp"),eqCharPos(e.getCursor(),Pos(1,1))})),testCM("lineWidgetFocus",(function(e){var o=document.getElementById("testground");o.className="offscreen";try{addDoc(e,500,10);var t=document.createElement("input");e.addLineWidget(1,t);t.focus(),eq(document.activeElement,t),e.replaceRange("new stuff",Pos(1,0)),eq(document.activeElement,t)}finally{o.className=""}})),testCM("lineWidgetCautiousRedraw",(function(e){var o=document.createElement("div");o.innerHTML="hahah";var t=e.addLineWidget(0,o),r=!1;t.on("redraw",(function(){r=!0})),e.replaceSelection("0"),is(!r)}),{value:"123\n456"}),testCM("lineWidgetChanged",(function(e){addDoc(e,2,300);var o=scrollbarWidth(e.display.measure)/2;e.setOption("lineNumbers",!0),e.setSize(600,50*e.defaultTextHeight()),e.scrollTo(null,e.heightAtLine(125,"local"));var t=60;function r(){var e=document.createElement("div"),r='<div style="display: inline-block; height: 1px; width: '+(285-o)+'px;"></div>',s='<div style="display: inline-block; height: 1px; width: '+(305-o)+'px;"></div>';return e.innerHTML=new Array(3).join(r)+new Array(3).join(s),e.style.cssText="background: yellow;font-size:0;line-height: "+t/3+"px;",e}var s=e.getScrollInfo(),a=e.addLineWidget(0,r(),{coverGutter:!0}),n=e.addLineWidget(150,r(),{coverGutter:!0}),i=e.addLineWidget(300,r(),{coverGutter:!0}),u=e.getScrollInfo();eq(s.height+3*t,u.height),eq(s.top+t,u.top),t=12,a.node.style.lineHeight=n.node.style.lineHeight=i.node.style.lineHeight=t/3+"px",a.changed(),n.changed(),i.changed();var l=e.getScrollInfo();eq(s.height+3*t,l.height),eq(s.top+t,l.top)})),testCM("lineWidgetIssue5486",(function(e){e.setValue("Lorem\nIpsue\nDollar");var o=document.createElement("div");o.style.height="50px",o.textContent="[[LINE WIDGET]]";var t=e.addLineWidget(1,o,{above:!1,coverGutter:!1,noHScroll:!1,showIfHidden:!1}),r=document.createElement("span");r.textContent="[--]",e.markText({line:0,ch:1},{line:1,ch:4},{replacedWith:r});var s=Math.round(e.charCoords({line:2,ch:0}).top);o.style.height="100px",o.textContent+="\nlineWidget size changed.\nTry moving cursor to line 3?",t.changed();var a=Math.round(e.charCoords({line:2,ch:0}).top);eq(a,s+50),e.replaceRange("-",{line:1,ch:5});var n=Math.round(e.charCoords({line:2,ch:0}).top);eq(n,a)})),testCM("getLineNumber",(function(e){addDoc(e,2,20);var o=e.getLineHandle(1);eq(e.getLineNumber(o),1),e.replaceRange("hi\nbye\n",Pos(0,0)),eq(e.getLineNumber(o),3),e.setValue(""),eq(e.getLineNumber(o),null)})),testCM("jumpTheGap",(function(e){var o="abcdef ghiklmnop qrstuvw xyz ";o+=o,o+=o,o+=o,e.replaceRange(o,Pos(2,0),Pos(2)),e.setSize("200px",null),e.getWrapperElement().style.lineHeight=2,e.refresh(),e.setCursor(Pos(0,1)),e.execCommand("goLineDown"),eqCharPos(e.getCursor(),Pos(1,1)),e.execCommand("goLineDown"),eqCharPos(e.getCursor(),Pos(2,1)),e.execCommand("goLineDown"),eq(e.getCursor().line,2),is(e.getCursor().ch>1),e.execCommand("goLineUp"),eqCharPos(e.getCursor(),Pos(2,1)),e.execCommand("goLineUp"),eqCharPos(e.getCursor(),Pos(1,1));var t=document.createElement("div");t.innerHTML="hi",t.style.height="30px",e.addLineWidget(0,t),e.addLineWidget(1,t.cloneNode(!0),{above:!0}),e.setCursor(Pos(0,2)),e.execCommand("goLineDown"),eqCharPos(e.getCursor(),Pos(1,2)),e.execCommand("goLineUp"),eqCharPos(e.getCursor(),Pos(0,2))}),{lineWrapping:!0,value:"abc\ndef\nghi\njkl\n"}),testCM("addLineClass",(function(e){function o(o,t,r,s,a){var n=e.lineInfo(o);eq(n.textClass,t),eq(n.bgClass,r),eq(n.wrapClass,s),void 0!==n.handle.gutterClass&&eq(n.handle.gutterClass,a)}e.addLineClass(0,"text","foo"),e.addLineClass(0,"text","bar"),e.addLineClass(1,"background","baz"),e.addLineClass(1,"wrap","foo"),e.addLineClass(1,"gutter","gutter-class"),o(0,"foo bar",null,null,null),o(1,null,"baz","foo","gutter-class");var t=e.display.lineDiv;eq(byClassName(t,"foo").length,2),eq(byClassName(t,"bar").length,1),eq(byClassName(t,"baz").length,1),eq(byClassName(t,"gutter-class").length,2),e.removeLineClass(0,"text","foo"),o(0,"bar",null,null,null),e.removeLineClass(0,"text","foo"),o(0,"bar",null,null,null),e.removeLineClass(0,"text","bar"),o(0,null,null,null),e.addLineClass(1,"wrap","quux"),o(1,null,"baz","foo quux","gutter-class"),e.removeLineClass(1,"wrap"),o(1,null,"baz",null,"gutter-class"),e.removeLineClass(1,"gutter","gutter-class"),eq(byClassName(t,"gutter-class").length,0),o(1,null,"baz",null,null),e.addLineClass(1,"gutter","gutter-class"),o(1,null,"baz",null,"gutter-class"),e.removeLineClass(1,"gutter","gutter-class"),o(1,null,"baz",null,null)}),{value:"hohoho\n",lineNumbers:!0}),testCM("atomicMarker",(function(e){function o(o,t,r,s,a,n,i,u){var l={atomic:!0,inclusiveLeft:a,inclusiveRight:n};return!0!==i&&!1!==i||(l.selectLeft=i),!0!==u&&!1!==u||(l.selectRight=u),e.markText(Pos(o,t),Pos(r,s),l)}addDoc(e,10,10);var t=o(0,1,0,5);e.setCursor(Pos(0,1)),e.execCommand("goCharRight"),eqCursorPos(e.getCursor(),Pos(0,5)),e.execCommand("goCharLeft"),eqCursorPos(e.getCursor(),Pos(0,1)),t.clear(),t=o(0,0,0,5,!0),eqCursorPos(e.getCursor(),Pos(0,5),"pushed out"),e.execCommand("goCharLeft"),eqCursorPos(e.getCursor(),Pos(0,5)),t.clear(),t=o(0,0,0,5,!1,!1,!1),e.setCursor(Pos(0,5)),eqCursorPos(e.getCursor(),Pos(0,5),"pushed out"),e.execCommand("goCharLeft"),eqCursorPos(e.getCursor(),Pos(0,5)),t.clear(),t=o(0,0,0,5,!1,!1,!0),e.setCursor(Pos(0,5)),eqCursorPos(e.getCursor(),Pos(0,5),"pushed out"),e.execCommand("goCharLeft"),eqCursorPos(e.getCursor(),Pos(0,0)),t.clear(),t=o(0,0,0,5,!1,!0),e.setCursor(Pos(0,0)),eqCursorPos(e.getCursor(),Pos(0,0)),e.execCommand("goCharRight"),eqCursorPos(e.getCursor(),Pos(0,6)),t.clear(),t=o(0,0,0,5,!1,!1,!0,!1),e.setCursor(Pos(0,0)),eqCursorPos(e.getCursor(),Pos(0,0)),e.execCommand("goCharRight"),eqCursorPos(e.getCursor(),Pos(0,6)),t.clear(),t=o(0,0,0,5,!1,!1,!0,!0),e.setCursor(Pos(0,0)),eqCursorPos(e.getCursor(),Pos(0,0)),e.execCommand("goCharRight"),eqCursorPos(e.getCursor(),Pos(0,5)),t.clear(),t=o(8,4,9,10,!1,!0),e.setCursor(Pos(9,8)),eqCursorPos(e.getCursor(),Pos(8,4),"set"),e.execCommand("goCharRight"),eqCursorPos(e.getCursor(),Pos(8,4),"char right"),e.execCommand("goLineDown"),eqCursorPos(e.getCursor(),Pos(8,4),"line down"),e.execCommand("goCharLeft"),eqCursorPos(e.getCursor(),Pos(8,3,"after")),t.clear(),t=o(1,1,3,8),e.setCursor(Pos(0,0)),e.setCursor(Pos(2,0)),eqCursorPos(e.getCursor(),Pos(3,8)),e.execCommand("goCharLeft"),eqCursorPos(e.getCursor(),Pos(1,1)),e.execCommand("goCharRight"),eqCursorPos(e.getCursor(),Pos(3,8)),e.execCommand("goLineUp"),eqCursorPos(e.getCursor(),Pos(1,1)),e.execCommand("goLineDown"),eqCursorPos(e.getCursor(),Pos(3,8)),e.execCommand("delCharBefore"),eq(e.getValue().length,80,"del chunk"),t.clear(),addDoc(e,10,10),t=o(3,0,5,5),e.setCursor(Pos(3,0)),e.execCommand("delWordAfter"),eq(e.getValue().length,82,"del chunk"),t.clear(),addDoc(e,10,10)})),testCM("selectionBias",(function(e){e.markText(Pos(0,1),Pos(0,3),{atomic:!0}),e.setCursor(Pos(0,2)),eqCursorPos(e.getCursor(),Pos(0,1)),e.setCursor(Pos(0,2)),eqCursorPos(e.getCursor(),Pos(0,3)),e.setCursor(Pos(0,2)),eqCursorPos(e.getCursor(),Pos(0,1)),e.setCursor(Pos(0,2),null,{bias:-1}),eqCursorPos(e.getCursor(),Pos(0,1)),e.setCursor(Pos(0,4)),e.setCursor(Pos(0,2),null,{bias:1}),eqCursorPos(e.getCursor(),Pos(0,3))}),{value:"12345"}),testCM("selectionHomeEnd",(function(e){e.markText(Pos(1,0),Pos(1,1),{atomic:!0,inclusiveLeft:!0}),e.markText(Pos(1,3),Pos(1,4),{atomic:!0,inclusiveRight:!0}),e.setCursor(Pos(1,2)),e.execCommand("goLineStart"),eqCursorPos(e.getCursor(),Pos(1,1)),e.execCommand("goLineEnd"),eqCursorPos(e.getCursor(),Pos(1,3))}),{value:"ab\ncdef\ngh"}),testCM("readOnlyMarker",(function(e){function o(o,t,r,s,a){return e.markText(Pos(o,t),Pos(r,s),{readOnly:!0,atomic:a})}var t=o(0,1,0,4);e.setCursor(Pos(0,2)),e.replaceSelection("hi","end"),eqCursorPos(e.getCursor(),Pos(0,2)),eq(e.getLine(0),"abcde"),e.execCommand("selectAll"),e.replaceSelection("oops","around"),eq(e.getValue(),"oopsbcd"),e.undo(),eqCursorPos(t.find().from,Pos(0,1)),eqCursorPos(t.find().to,Pos(0,4)),t.clear(),e.setCursor(Pos(0,2)),e.replaceSelection("hi","around"),eq(e.getLine(0),"abhicde"),eqCursorPos(e.getCursor(),Pos(0,4)),t=o(0,2,2,2,!0),e.setSelection(Pos(1,1),Pos(2,4)),e.replaceSelection("t","end"),eqCursorPos(e.getCursor(),Pos(2,3)),eq(e.getLine(2),"klto"),e.execCommand("goCharLeft"),e.execCommand("goCharLeft"),eqCursorPos(e.getCursor(),Pos(0,2)),e.setSelection(Pos(0,1),Pos(0,3)),e.replaceSelection("xx","around"),eqCursorPos(e.getCursor(),Pos(0,3)),eq(e.getLine(0),"axxhicde")}),{value:"abcde\nfghij\nklmno\n"}),testCM("dirtyBit",(function(e){eq(e.isClean(),!0),e.replaceSelection("boo",null,"test"),eq(e.isClean(),!1),e.undo(),eq(e.isClean(),!0),e.replaceSelection("boo",null,"test"),e.replaceSelection("baz",null,"test"),e.undo(),eq(e.isClean(),!1),e.markClean(),eq(e.isClean(),!0),e.undo(),eq(e.isClean(),!1),e.redo(),eq(e.isClean(),!0)})),testCM("changeGeneration",(function(e){e.replaceSelection("x");var o=e.changeGeneration();e.replaceSelection("x"),e.undo(),eq(e.getValue(),""),is(!e.isClean(o)),e.replaceSelection("x");var t=e.changeGeneration(!0);e.replaceSelection("x"),e.undo(),eq(e.getValue(),"x"),is(e.isClean(t))})),testCM("addKeyMap",(function(e){function o(o){e.triggerOnKeyDown({type:"keydown",keyCode:o,preventDefault:function(){},stopPropagation:function(){}})}o(39),eqCursorPos(e.getCursor(),Pos(0,1,"before"));var t=0,r={Right:function(){++t}},s={Right:function(){t+=10}};e.addKeyMap(r),o(39),eqCursorPos(e.getCursor(),Pos(0,1,"before")),eq(t,1),e.addKeyMap(s,!0),o(39),eq(t,2),e.removeKeyMap(r),o(39),eq(t,12),e.removeKeyMap(s),o(39),eq(t,12),eqCursorPos(e.getCursor(),Pos(0,2,"before")),e.addKeyMap({Right:function(){t=55},name:"mymap"}),o(39),eq(t,55),e.removeKeyMap("mymap"),o(39),eqCursorPos(e.getCursor(),Pos(0,3,"before"))}),{value:"abc"}),testCM("mouseBinding",(function(e){var o=[];function t(o,t){mouseDown(e,o,Pos(1,2),t)}e.addKeyMap({"Shift-LeftClick":function(e,t){eqCharPos(t,Pos(1,2)),o.push("a")},"Shift-LeftDoubleClick":function(){o.push("b")},"Shift-LeftTripleClick":function(){o.push("c")}}),t(1,{shiftKey:!0}),t(1,{shiftKey:!0}),t(1,{shiftKey:!0}),t(1,{}),t(2,{ctrlKey:!0}),t(2,{ctrlKey:!0}),eq(o.join(" "),"a b c")}),{value:"foo\nbar\nbaz"}),testCM("configureMouse",(function(e){e.setOption("configureMouse",(function(){return{unit:"word"}})),mouseDown(e,1,Pos(0,5)),eqCharPos(e.getCursor("from"),Pos(0,4)),eqCharPos(e.getCursor("to"),Pos(0,7)),e.setOption("configureMouse",(function(){return{extend:!0}})),mouseDown(e,1,Pos(0,0)),eqCharPos(e.getCursor("from"),Pos(0,0)),eqCharPos(e.getCursor("to"),Pos(0,4))}),{value:"foo bar baz"}),testCM("findPosH",(function(e){forEach([{from:Pos(0,0),to:Pos(0,1,"before"),by:1},{from:Pos(0,0),to:Pos(0,0),by:-1,hitSide:!0},{from:Pos(0,0),to:Pos(0,4,"before"),by:1,unit:"word"},{from:Pos(0,0),to:Pos(0,8,"before"),by:2,unit:"word"},{from:Pos(0,0),to:Pos(2,0,"after"),by:20,unit:"word",hitSide:!0},{from:Pos(0,7),to:Pos(0,5,"after"),by:-1,unit:"word"},{from:Pos(0,4),to:Pos(0,8,"before"),by:1,unit:"word"},{from:Pos(1,0),to:Pos(1,18,"before"),by:3,unit:"word"},{from:Pos(1,22),to:Pos(1,5,"after"),by:-3,unit:"word"},{from:Pos(1,15),to:Pos(1,10,"after"),by:-5},{from:Pos(1,15),to:Pos(1,10,"after"),by:-5,unit:"column"},{from:Pos(1,15),to:Pos(1,0,"after"),by:-50,unit:"column",hitSide:!0},{from:Pos(1,15),to:Pos(1,24,"before"),by:50,unit:"column",hitSide:!0},{from:Pos(1,15),to:Pos(2,0,"after"),by:50,hitSide:!0}],(function(o){var t=e.findPosH(o.from,o.by,o.unit||"char");eqCursorPos(t,o.to),eq(!!t.hitSide,!!o.hitSide)}))}),{value:"line one\nline two.something.other\n"}),testCM("beforeChange",(function(e){e.on("beforeChange",(function(e,o){for(var t=[],r=0;r<o.text.length;++r)t.push(o.text[r].replace(/\s/g,"_"));o.update(null,null,t)})),e.setValue("hello, i am a\nnew document\n"),eq(e.getValue(),"hello,_i_am_a\nnew_document\n"),CodeMirror.on(e.getDoc(),"beforeChange",(function(e,o){0==o.from.line&&o.cancel()})),e.setValue("oops"),eq(e.getValue(),"hello,_i_am_a\nnew_document\n"),e.replaceRange("hey hey hey",Pos(1,0),Pos(2,0)),eq(e.getValue(),"hello,_i_am_a\nhey_hey_hey")}),{value:"abcdefghijk"}),testCM("beforeChangeUndo",(function(e){e.replaceRange("hi",Pos(0,0),Pos(0)),e.replaceRange("bye",Pos(0,0),Pos(0)),eq(e.historySize().undo,2),e.on("beforeChange",(function(e,o){is(!o.update),o.cancel()})),e.undo(),eq(e.historySize().undo,0),eq(e.getValue(),"bye\ntwo")}),{value:"one\ntwo"}),testCM("beforeSelectionChange",(function(e){function o(e,o){var t=e.getLine(o.line).length;return t&&o.ch!=t?o:Pos(o.line,o.ch-1)}e.on("beforeSelectionChange",(function(e,t){t.update([{anchor:o(e,t.ranges[0].anchor),head:o(e,t.ranges[0].head)}])})),addDoc(e,10,10),e.execCommand("goLineEnd"),eqCursorPos(e.getCursor(),Pos(0,9)),e.execCommand("selectAll"),eqCursorPos(e.getCursor("start"),Pos(0,0)),eqCursorPos(e.getCursor("end"),Pos(9,9))})),testCM("change_removedText",(function(e){e.setValue("abc\ndef");var o=[];e.on("change",(function(e,t){o.push(t.removed)})),e.operation((function(){e.replaceRange("xyz",Pos(0,0),Pos(1,1)),e.replaceRange("123",Pos(0,0))})),eq(o.length,2),eq(o[0].join("\n"),"abc\nd"),eq(o[1].join("\n"),"");o=[];e.undo(),eq(o.length,2),eq(o[0].join("\n"),"123"),eq(o[1].join("\n"),"xyz");o=[];e.redo(),eq(o.length,2),eq(o[0].join("\n"),"abc\nd"),eq(o[1].join("\n"),"")})),testCM("lineStyleFromMode",(function(e){CodeMirror.defineMode("test_mode",(function(){return{token:function(e){return e.match(/^\[[^\]]*\]/)?"  line-brackets  ":e.match(/^\([^\)]*\)/)?"  line-background-parens  ":e.match(/^<[^>]*>/)?"  span  line-line  line-background-bg  ":void e.match(/^\s+|^\S+/)}}})),e.setOption("mode","test_mode");var o=byClassName(e.getWrapperElement(),"brackets");eq(o.length,1,"brackets count"),eq(o[0].nodeName,"PRE"),is(!/brackets.*brackets/.test(o[0].className));var t=byClassName(e.getWrapperElement(),"parens");eq(t.length,1,"parens count"),eq(t[0].nodeName,"DIV"),is(!/parens.*parens/.test(t[0].className)),eq(t[0].parentElement.nodeName,"DIV"),is(byClassName(e.getWrapperElement(),"bg").length>0),is(byClassName(e.getWrapperElement(),"line").length>0);var r=byClassName(e.getWrapperElement(),"cm-span");eq(r.length,2),is(/^\s*cm-span\s*$/.test(r[0].className))}),{value:"line1: [br] [br]\nline2: (par) (par)\nline3: <tag> <tag>"}),testCM("lineStyleFromBlankLine",(function(e){CodeMirror.defineMode("lineStyleFromBlankLine_mode",(function(){return{token:function(e){return e.skipToEnd(),"comment"},blankLine:function(){return"line-blank"}}})),e.setOption("mode","lineStyleFromBlankLine_mode");var o=byClassName(e.getWrapperElement(),"blank");eq(o.length,1),eq(o[0].nodeName,"PRE"),e.replaceRange("x",Pos(1,0)),o=byClassName(e.getWrapperElement(),"blank"),eq(o.length,0)}),{value:"foo\n\nbar"}),CodeMirror.registerHelper("xxx","a","A"),CodeMirror.registerHelper("xxx","b","B"),CodeMirror.defineMode("yyy",(function(){return{token:function(e){e.skipToEnd()},xxx:["a","b","q"]}})),CodeMirror.registerGlobalHelper("xxx","c",(function(e){return e.enableC}),"C"),testCM("helpers",(function(e){e.setOption("mode","yyy"),eq(e.getHelpers(Pos(0,0),"xxx").join("/"),"A/B"),e.setOption("mode",{name:"yyy",modeProps:{xxx:"b",enableC:!0}}),eq(e.getHelpers(Pos(0,0),"xxx").join("/"),"B/C"),e.setOption("mode","javascript"),eq(e.getHelpers(Pos(0,0),"xxx").join("/"),"")})),testCM("selectionHistory",(function(e){for(var o=0;o<3;o++)e.setExtending(!0),e.execCommand("goCharRight"),e.setExtending(!1),e.execCommand("goCharRight"),e.execCommand("goCharRight");e.execCommand("undoSelection"),eq(e.getSelection(),"c"),e.execCommand("undoSelection"),eq(e.getSelection(),""),eqCursorPos(e.getCursor(),Pos(0,4,"before")),e.execCommand("undoSelection"),eq(e.getSelection(),"b"),e.execCommand("redoSelection"),eq(e.getSelection(),""),eqCursorPos(e.getCursor(),Pos(0,4,"before")),e.execCommand("redoSelection"),eq(e.getSelection(),"c"),e.execCommand("redoSelection"),eq(e.getSelection(),""),eqCursorPos(e.getCursor(),Pos(0,6,"before"))}),{value:"a b c d"}),testCM("selectionChangeReducesRedo",(function(e){e.replaceSelection("X"),e.execCommand("goCharRight"),e.undoSelection(),e.execCommand("selectAll"),e.undoSelection(),eq(e.getValue(),"Xabc"),eqCursorPos(e.getCursor(),Pos(0,1)),e.undoSelection(),eq(e.getValue(),"abc")}),{value:"abc"}),testCM("selectionHistoryNonOverlapping",(function(e){e.setSelection(Pos(0,0),Pos(0,1)),e.setSelection(Pos(0,2),Pos(0,3)),e.execCommand("undoSelection"),eqCursorPos(e.getCursor("anchor"),Pos(0,0)),eqCursorPos(e.getCursor("head"),Pos(0,1))}),{value:"1234"}),testCM("cursorMotionSplitsHistory",(function(e){e.replaceSelection("a"),e.execCommand("goCharRight"),e.replaceSelection("b"),e.replaceSelection("c"),e.undo(),eq(e.getValue(),"a1234"),eqCursorPos(e.getCursor(),Pos(0,2,"before")),e.undo(),eq(e.getValue(),"1234"),eqCursorPos(e.getCursor(),Pos(0,0))}),{value:"1234"}),testCM("selChangeInOperationDoesNotSplit",(function(e){for(var o=0;o<4;o++)e.operation((function(){e.replaceSelection("x"),e.setCursor(Pos(0,e.getCursor().ch-1))}));eqCursorPos(e.getCursor(),Pos(0,0)),eq(e.getValue(),"xxxxa"),e.undo(),eq(e.getValue(),"a")}),{value:"a"}),testCM("alwaysMergeSelEventWithChangeOrigin",(function(e){e.replaceSelection("U",null,"foo"),e.setSelection(Pos(0,0),Pos(0,1),{origin:"foo"}),e.undoSelection(),eq(e.getValue(),"a"),e.replaceSelection("V",null,"foo"),e.setSelection(Pos(0,0),Pos(0,1),{origin:"bar"}),e.undoSelection(),eq(e.getValue(),"Va")}),{value:"a"}),testCM("getTokenAt",(function(e){var o=e.getTokenAt(Pos(0,2));eq(o.type,"operator"),eq(o.string,"+");var t=e.getLineTokens(0);eq(t.length,3),forEach([["number","1"],["operator","+"],["number","2"]],(function(e,o){eq(t[o].type,e[0]),eq(t[o].string,e[1])}))}),{value:"1+2",mode:"javascript"}),testCM("getTokenTypeAt",(function(e){eq(e.getTokenTypeAt(Pos(0,0)),"number"),eq(e.getTokenTypeAt(Pos(0,6)),"string"),e.addOverlay({token:function(e){if(e.match("foo"))return"foo";e.next()}}),eq(byClassName(e.getWrapperElement(),"cm-foo").length,1),eq(e.getTokenTypeAt(Pos(0,6)),"string")}),{value:"1 + 'foo'",mode:"javascript"}),testCM("addOverlay",(function(e){e.addOverlay({token:function(e){var o=e.baseToken();if(!/comment/.test(o.type)&&e.match(/\d+/))return"x";e.next()}});var o=byClassName(e.getWrapperElement(),"cm-x");is(o.length,1),is(o[0].textContent,"233"),e.replaceRange("",Pos(0,4),Pos(0,6)),is(byClassName(e.getWrapperElement(),"cm-x").length,2)}),{value:"foo /* 100 */\nbar + 233;\nbaz",mode:"javascript"}),testCM("resizeLineWidget",(function(e){addDoc(e,200,3);var o=document.createElement("pre");o.innerHTML="imwidget",o.style.background="yellow",e.addLineWidget(1,o,{noHScroll:!0}),e.setSize(40),is(o.parentNode.offsetWidth<42)})),testCM("combinedOperations",(function(e){var o=document.getElementById("testground"),t=CodeMirror(o,{value:"123"});try{e.operation((function(){e.addLineClass(0,"wrap","foo"),t.addLineClass(0,"wrap","foo")})),eq(byClassName(e.getWrapperElement(),"foo").length,1),eq(byClassName(t.getWrapperElement(),"foo").length,1),e.operation((function(){e.removeLineClass(0,"wrap","foo"),t.removeLineClass(0,"wrap","foo")})),eq(byClassName(e.getWrapperElement(),"foo").length,0),eq(byClassName(t.getWrapperElement(),"foo").length,0)}finally{o.removeChild(t.getWrapperElement())}}),{value:"abc"}),testCM("eventOrder",(function(e){var o=[];e.on("change",(function(){o.length||e.replaceSelection("."),o.push("change")})),e.on("cursorActivity",(function(){e.replaceSelection("!"),o.push("activity")})),e.replaceSelection("/"),eq(o.join(","),"change,change,activity,change")})),testCM("splitSpaces_nonspecial",(function(e){eq(byClassName(e.getWrapperElement(),"cm-invalidchar").length,0)}),{specialChars:/[\u00a0]/,value:"spaces ->            <- between"}),test("core_rmClass",(function(){var e=document.createElement("div");e.className="foo-bar baz-quux yadda",CodeMirror.rmClass(e,"quux"),eq(e.className,"foo-bar baz-quux yadda"),CodeMirror.rmClass(e,"baz-quux"),eq(e.className,"foo-bar yadda"),CodeMirror.rmClass(e,"yadda"),eq(e.className,"foo-bar"),CodeMirror.rmClass(e,"foo-bar"),eq(e.className,""),e.className=" foo ",CodeMirror.rmClass(e,"foo"),eq(e.className,"")})),test("core_addClass",(function(){var e=document.createElement("div");CodeMirror.addClass(e,"a"),eq(e.className,"a"),CodeMirror.addClass(e,"a"),eq(e.className,"a"),CodeMirror.addClass(e,"b"),eq(e.className,"a b"),CodeMirror.addClass(e,"a"),CodeMirror.addClass(e,"b"),eq(e.className,"a b")})),testCM("lineSeparator",(function(e){eq(e.lineCount(),3),eq(e.getLine(1),"bar\r"),eq(e.getLine(2),"baz\rquux"),e.setOption("lineSeparator","\r"),eq(e.lineCount(),5),eq(e.getLine(4),"quux"),eq(e.getValue(),"foo\rbar\r\rbaz\rquux"),eq(e.getValue("\n"),"foo\nbar\n\nbaz\nquux"),e.setOption("lineSeparator",null),e.setValue("foo\nbar\r\nbaz\rquux"),eq(e.lineCount(),4)}),{value:"foo\nbar\r\nbaz\rquux",lineSeparator:"\n"});var extendingChars=/[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/,getChar=function(e){var o;do{o=String.fromCharCode(Math.floor(2220*Math.random()))}while(-1!=[144].indexOf(o.charCodeAt(0))||e&&extendingChars.test(o));return o},getString=function(e){for(var o=getChar(!0);--e>0;)o+=getChar();return o};function makeItWrapAfter(e,o){for(var t,r=e.cursorCoords(Pos(0,0)).top,s=0;t!=r;++s)e.setSize(s),t=e.charCoords(o).top}function countIf(e,o){for(var t=0,r=0;r<e.length;r++)o[e[r]]&&t++;return t}function testMoveBidi(e){testCM("move_bidi_"+e,(function(o){if("textarea"==o.getOption("inputStyle")&&o.getOption("rtlMoveVisually")){o.getScrollerElement().style.fontFamily="monospace",makeItWrapAfter(o,Pos(0,5));var t=e.length-countIf(e.split(""),(function(e){return extendingChars.test(e)})),r={};r[6-countIf(e.substr(0,5).split(""),(function(e){return extendingChars.test(e)}))]="w",-1!=e.indexOf("\n")&&(r[t-2]="n"),o.execCommand("goLineStart");for(var s,a=o.cursorCoords(),n=0;n<t;++n)o.execCommand("goCharRight"),s=o.cursorCoords(),n>=10&&n<=12&&!r[n]&&s.left<a.left&&s.top>a.top&&(r[n]="w"),r[n]?(is(s.left<a.left,n),is(s.top>a.top,n)):(is(s.left>a.left,"In step "+n+", cursor didn't move right"),eq(s.top,a.top,"In step "+n+", cursor moved out of line")),a=s;for(o.execCommand("goCharRight"),s=o.cursorCoords(),eq(s.left,a.left,"Moving "+t+" steps right didn't reach the end"),eq(s.top,a.top,"Moving "+t+" steps right didn't reach the end"),n=t-1;n>=0;--n)o.execCommand("goCharLeft"),s=o.cursorCoords(),"n"!=r[n]&&"w"!=r[n+1]?(is(s.left<a.left,"In step "+n+", cursor didn't move left"),eq(s.top,a.top,"In step "+n+", cursor is not at the same line anymore")):(is(s.left>a.left,n),is(s.top<a.top,n)),a=s;o.execCommand("goCharLeft"),s=o.cursorCoords(),eq(s.left,a.left,"Moving "+t+" steps left didn't reach the beginning"),eq(s.top,a.top,"Moving "+t+" steps left didn't reach the beginning")}}),{value:e,lineWrapping:!0})}function testMoveEndBidi(e){testCM("move_end_bidi_"+e,(function(e){e.getScrollerElement().style.fontFamily="monospace",makeItWrapAfter(e,Pos(0,5)),e.execCommand("goLineStart");var o=e.doc.getCursor();e.execCommand("goCharLeft"),eqCursorPos(o,e.doc.getCursor()),e.execCommand("goLineEnd"),o=e.doc.getCursor(),e.execCommand("goColumnRight"),eqCursorPos(o,e.doc.getCursor())}),{value:e,lineWrapping:!0})}var bidiTests=[];bidiTests.push("\u038c\u021d\u01dd\u06aa\u0209\u06e5\u05f4\u06fa\u05c6\u0240\u04a9\u06cf\n\u04b3"),window.automatedTests||bidiTests.push("\u014c\u04f0\u0442\u0642\u0224\u0601\u01a5\u0605\u0663\u010e\u023a\u0661\n\u03da"),bidiTests.push("\u067b\u043e\u04a4\u0455\u047d\u03a9\u05be\u0609\xef\u03af\u0584\u01f3\n\u0675"),bidiTests.push("\u0605\u0601\u0106\u0555\u01bf\u0241\u01de\u03ee\u0620\u0229\xf3\u0107\n\u010f"),bidiTests.push("R\u0168\u010f\u04a3\u016az\u03e2\u014e\u018f\u0516\u0687\u06a6\n\u04c8"),bidiTests.push("\u03cc\u05ca\u06f7\u0662\u051c\u04bb\u041e\u05e6\u0409\u064a\u010d\u01df\n\u0469"),bidiTests.push("\u06d1\xda\u04b3\u0495\u06ac\u0121\u06b9\u0570\u044f\u0173KV\nr"),bidiTests.push("\u017a\u06bb\u0493\xfa\u06c14\u05dd1\u0220c1a\n\u0501"),bidiTests.push("\u0492\u0228\u049f\u0583\u019e\u0666\u0513\u0226\u06b0\u0493\xe2\u01a5\n\u06a4"),bidiTests.push("\u03d6\u0633\u0549\u020f\u0167\u0394\u051b\u01c6\u010e\u04df\u06cc\u06a1\n\u03ad"),bidiTests.push("\u06f9\u063cL\u06f5\u013a\u0227\u041a\u0519\u063b\u05d07\u05f4\n\u0645"),bidiTests.push("\u0646 (\u064a)\u2009\u0623\u0642\u0648\u0627\u0633"),bidiTests.push("\u0584\u0574\u0467\u01ee\xdf\u067e\xfc\u0162\u048d\u049e\u045e\u06b3\n\u04e7");for(var i=0;i<bidiTests.length;++i)testMoveBidi(bidiTests[i]),testMoveEndBidi(bidiTests[i]);function testCoordsWrappedBidi(e){testCM("coords_wrapped_bidi_"+e,(function(o){o.getScrollerElement().style.fontFamily="monospace",makeItWrapAfter(o,Pos(0,5));var t,r=Pos(0,0);o.doc.setCursor(r);do{t=r,o.execCommand("goCharLeft"),r=o.doc.getCursor()}while(r!=t);for(var s,a=o.charCoords(Pos(0,0)).top,n=1;n<e.length;++n)s=a,a=o.charCoords(Pos(0,n)).top,is(a>=s)}),{value:e,lineWrapping:!0})}testCoordsWrappedBidi("Count \u0661 \u0662 \u0663 \u0664"),testCM("rtl_wrapped_selection",(function(e){e.setSelection(Pos(0,10),Pos(0,190)),is(byClassName(e.getWrapperElement(),"CodeMirror-selected").length>=3)}),{value:new Array(10).join(" \u0641\u062a\u064a \u062a\u0645 \u062a\u0636\u0645\u064a\u0646\u0647\u0627 \u0641\u062a\u064a \u062a\u0645"),lineWrapping:!0}),testCM("bidi_wrapped_selection",(function(e){e.setSize(e.charCoords(Pos(0,10),"editor").left),e.setSelection(Pos(0,37),Pos(0,80));var o=byClassName(e.getWrapperElement(),"CodeMirror-selected");is(o.length>=2),is(o.length<=3);var t=o[0].getBoundingClientRect(),r=o[o.length-1].getBoundingClientRect();is(t.left>e.charCoords(Pos(0,1)).right),is(r.right<e.charCoords(Pos(0,e.getLine(0).length-2)).left)}),{value:"<p>\u0645\u0641\u062a\u064a11 \u062a\u0645 \u062a\u0636\u0645\u064a\u0646\u0647\u0641\u062a\u064a \u062a\u0645 \u062a\u0636\u0645\u064a\u0646\u0647\u0627 \u0641\u062a\u064a \u062a\u0641\u062a\u064a \u062a\u0645 \u062a\u0636\u0645\u064a\u0646\u0647\u0627 \u0641\u062a\u064a \u062a\u0641\u062a\u064a \u062a\u0645 \u062a\u0636\u0645\u064a\u0646\u0647\u0627 \u0641\u062a\u064a \u062a\u0641\u062a\u064a \u062a\u0645 \u062a\u0636\u0645\u064a\u0646\u0647\u0627 \u0641\u062a\u064a \u062a\u0627 \u0641\u062a10\u064a \u062a</p>",lineWrapping:!0}),testCM("delete_wrapped",(function(e){makeItWrapAfter(e,Pos(0,2)),e.doc.setCursor(Pos(0,3,"after")),e.deleteH(-1,"char"),eq(e.getLine(0),"1245")}),{value:"12345",lineWrapping:!0}),testCM("issue_4878",(function(e){window.automatedTests||(e.setCursor(Pos(1,12,"after")),e.moveH(-1,"char"),eqCursorPos(e.getCursor(),Pos(0,113,"before")))}),{value:'  \u0641\u064a \u062a\u0637\u0628\u064a\u0642 \u0627\u0644\u0633\u0645\u0627\u062a \u0645\u0631\u0629 \u0648\u0627\u062d\u062f\u0629 https://github.com/codemirror/CodeMirror/issues/4878#issuecomment-330550964\u0639\u0644\u0649 \u0633\u0628\u064a\u0644 \u0627\u0644\u0645\u062b\u0627\u0644 <code>"foo bar"</code>\n  \u0633\u064a\u062a\u0645 \u062a\u0639\u064a\u064a\u0646',direction:"rtl",lineWrapping:!0}),CodeMirror.defineMode("lookahead_mode",(function(){return{token:function(e){return e.skipToEnd(),/x/.test(e.lookAhead(2))?"atom":null}}})),testCM("mode_lookahead",(function(e){eq(e.getTokenAt(Pos(0,1)).type,"atom"),eq(e.getTokenAt(Pos(1,1)).type,"atom"),eq(e.getTokenAt(Pos(2,1)).type,null),e.replaceRange("\n",Pos(2,0)),eq(e.getTokenAt(Pos(0,1)).type,null),eq(e.getTokenAt(Pos(1,1)).type,"atom")}),{value:"foo\na\nx\nx\n",mode:"lookahead_mode"}),testCM("should have translate=no attribute",(function(e){eq(e.getWrapperElement().getAttribute("translate"),"no")}),{});