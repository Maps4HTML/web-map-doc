/*! @maps4html/web-map-custom-element 15-11-2023 */

import"./leaflet.js";import"./mapml.js";class MapLayer extends HTMLElement{static get observedAttributes(){return["src","label","checked","hidden","opacity"]}get src(){return this.hasAttribute("src")?this.getAttribute("src"):""}set src(e){e&&this.setAttribute("src",e)}get label(){return this._layer?this._layer.getName():this.hasAttribute("label")?this.getAttribute("label"):""}set label(e){e&&this.setAttribute("label",e)}get checked(){return this.hasAttribute("checked")}set checked(e){e?this.setAttribute("checked",""):this.removeAttribute("checked")}get hidden(){return this.hasAttribute("hidden")}set hidden(e){e?this.setAttribute("hidden",""):this.removeAttribute("hidden")}get opacity(){return+(this._opacity??this.getAttribute("opacity"))}set opacity(e){1<+e||+e<0||this.setAttribute("opacity",e)}get extent(){return this._layer.bounds||this._layer._calculateBounds(),Object.assign(M._convertAndFormatPCRS(this._layer.bounds,this._layer._properties.crs,this._layer._properties.projection),{zoom:this._layer.zoomBounds})}constructor(){super()}disconnectedCallback(){this.hasAttribute("data-moving")||this._onRemove()}_onRemove(){this._layer&&this._layer.off(),this._layer&&this._layer._map&&this._layer._map.removeLayer(this._layer),this._layerControl&&!this.hidden&&this._layerControl.removeLayer(this._layer),delete this._layer,delete this._fetchError,this.shadowRoot&&(this.shadowRoot.innerHTML="")}connectedCallback(){if(!this.hasAttribute("data-moving")){this._createLayerControlHTML=M._createLayerControlHTML.bind(this),this._opacity=this.opacity||1;const e=this._onAdd.bind(this);this.parentElement.whenReady().then(()=>{e()}).catch(()=>{throw new Error("Map never became ready")})}}_onAdd(){this.getAttribute("src")&&!this.shadowRoot&&this.attachShadow({mode:"open"}),new Promise((r,t)=>{this.addEventListener("changestyle",function(e){e.stopPropagation(),this.src=e.detail.src},{once:!0}),this.addEventListener("changeprojection",function(e){e.stopPropagation(),t(e)},{once:!0});let a=this.baseURI||document.baseURI;const e=new Headers;e.append("Accept","text/mapml"),this.src?fetch(this.src,{headers:e}).then(e=>{if(!e.ok)throw new Error("HTTP error! Status: "+e.status);return e.text()}).then(e=>{let t=(new DOMParser).parseFromString(e,"text/xml");if(t.querySelector("parsererror")||!t.querySelector("mapml-"))throw new Error("Parser error");this._layer&&this._onRemove(),this._layer=M.mapMLLayer(new URL(this.src,a).href,this,t,{mapprojection:this.parentElement.projection,opacity:this.opacity}),this._createLayerControlHTML(),this._attachedToMap(),this._validateDisabled(),r()}).catch(e=>{this._fetchError=!0,console.log("Error fetching layer content"+e)}):(this._layer&&this._onRemove(),this._layer=M.mapMLLayer(null,this,null,{mapprojection:this.parentElement.projection,opacity:this.opacity}),this._createLayerControlHTML(),this._attachedToMap(),this._validateDisabled(),r())}).catch(e=>{"changeprojection"===e.type?this.src=e.detail.href:(console.log(e),this.dispatchEvent(new CustomEvent("error",{detail:{target:this}})))})}_attachedToMap(){for(var e=0,t=1,r=this.parentNode.children;e<r.length;e++)"LAYER-"===this.parentNode.children[e].nodeName&&(this.parentNode.children[e]===this?t=e+1:this.parentNode.children[e]._layer&&this.parentNode.children[e]._layer.setZIndex(e+1));var a=this.parentNode.projection||"OSMTILE";L.setOptions(this._layer,{zIndex:t,mapprojection:a,opacity:window.getComputedStyle(this).opacity}),this._layer._map=this.parentNode._map,this.checked&&this._layer.addTo(this._layer._map),this._layer.on("add remove",this._validateDisabled,this),this._layer._map.on("moveend layeradd",this._validateDisabled,this),this.parentNode._layerControl&&!this.hidden&&(this._layerControl=this.parentNode._layerControl,this._layerControl.addOrUpdateOverlay(this._layer,this.label)),this._layer._legendUrl&&(this.legendLinks=[{type:"application/octet-stream",href:this._layer._legendUrl,rel:"legend",lang:null,hreflang:null,sizes:null}]),this.dispatchEvent(new CustomEvent("loadedmetadata",{detail:{target:this}}))}attributeChangedCallback(e,t,r){switch(e){case"label":this.whenReady().then(()=>{this._layer.setName(r)}).catch(e=>{console.log(e)});break;case"checked":this.whenReady().then(()=>{"string"==typeof r?this.parentElement._map.addLayer(this._layer):this.parentElement._map.removeLayer(this._layer),this._layerControlCheckbox.checked=this.checked,this.dispatchEvent(new CustomEvent("map-change"))}).catch(e=>{console.log(e)});break;case"hidden":this.parentElement&&this.parentElement._map&&this.parentElement.controls&&("string"==typeof r?this._layer&&this.parentElement._layerControl.removeLayer(this._layer):(this._layerControl=this.parentElement._layerControl,this._layerControl.addOrUpdateOverlay(this._layer,this.label),this._validateDisabled()));break;case"opacity":t!==r&&this._layer&&(this._opacity=r,this._layer.changeOpacity(r));break;case"src":t!==r&&this._layer&&(this._onRemove(),this.isConnected&&this._onAdd())}}_validateDisabled(){setTimeout(()=>{var i=this._layer;if(i?._map){const o=(this.shadowRoot||this).querySelectorAll("map-extent");let t=0,r=0,a=["_staticTileLayer","_imageLayer","_mapmlvectors","_templatedLayer"];for(let e=0;e<a.length;e++){var s=a[e];if(this.checked)if("_templatedLayer"===s&&0<o.length)for(let e=0;e<o.length;e++)r++,o[e]._validateDisabled()&&t++;else i[s]&&(r++,i[s].isVisible||t++)}t===r&&0!==t?(this.setAttribute("disabled",""),this.disabled=!0):(this.removeAttribute("disabled"),this.disabled=!1),this.toggleLayerControlDisabled()}},0)}toggleLayerControlDisabled(){let e=this._layerControlCheckbox,t=this._layerControlLabel,r=this._opacityControl,a=this._opacitySlider,i=this._styles;this.disabled?(e.disabled=!0,a.disabled=!0,t.style.fontStyle="italic",r.style.fontStyle="italic",i&&(i.style.fontStyle="italic",i.querySelectorAll("input").forEach(e=>{e.disabled=!0}))):(e.disabled=!1,a.disabled=!1,t.style.fontStyle="normal",r.style.fontStyle="normal",i&&(i.style.fontStyle="normal",i.querySelectorAll("input").forEach(e=>{e.disabled=!1})))}getOuterHTML(){let t=this.cloneNode(!0);if(this.hasAttribute("src")&&(e=this._layer.getHref(),t.setAttribute("src",e)),this.querySelector("map-link")){let e=t.querySelectorAll("map-link");e.forEach(e=>{e.hasAttribute("href")?e.setAttribute("href",decodeURI(new URL(e.attributes.href.value,this.baseURI||document.baseURI).href)):e.hasAttribute("tref")&&e.setAttribute("tref",decodeURI(new URL(e.attributes.tref.value,this.baseURI||document.baseURI).href))})}var e=t.outerHTML;return t.remove(),e}zoomTo(){this.whenElemsReady().then(()=>{let e=this.parentElement._map,t=this.extent,r=t.topLeft.pcrs,a=t.bottomRight.pcrs,i=L.bounds(L.point(r.horizontal,r.vertical),L.point(a.horizontal,a.vertical)),s=e.options.crs.unproject(i.getCenter(!0));var o=t.zoom.maxZoom,l=t.zoom.minZoom;e.setView(s,M.getMaxZoom(i,e,l,o),{animate:!1})})}mapml2geojson(e={}){return M.mapml2geojson(this,e)}pasteFeature(e){switch(typeof e){case"string":e.trim(),"<map-feature"===e.slice(0,12)&&"</map-feature>"===e.slice(-14)&&this.insertAdjacentHTML("beforeend",e);break;case"object":"MAP-FEATURE"===e.nodeName.toUpperCase()&&this.appendChild(e)}}whenReady(){return new Promise((t,r)=>{let a,i;!this._layer||this.src&&!this.shadowRoot?.childNodes.length?(a=setInterval(function(e){!e._layer||e.src&&!e.shadowRoot?.childNodes.length?e._fetchError&&(clearInterval(a),clearTimeout(i),r("Error fetching layer content")):(clearInterval(a),clearTimeout(i),t())},200,this),i=setTimeout(function(){clearInterval(a),clearTimeout(i),r("Timeout reached waiting for layer to be ready")},5e3)):t()})}whenElemsReady(){let e=[],t=this.shadowRoot||this;for(var r of[...t.querySelectorAll("map-extent"),...t.querySelectorAll("map-feature")])e.push(r.whenReady());return Promise.allSettled(e)}}export{MapLayer};
//# sourceMappingURL=layer.js.map