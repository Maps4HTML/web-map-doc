{"version":3,"file":"map-area.js","sources":["../src/map-area.js"],"sourcesContent":["import './leaflet.js';  // a lightly modified version of Leaflet for use as browser module\nimport './mapml.js';       // refactored URI usage, replaced with URL standard\n\nexport class MapArea extends HTMLAreaElement {\n  static get observedAttributes() {\n    return ['coords','alt','href','shape','rel','type','target'];\n  }\n  // see comments below regarding attributeChangedCallback vs. getter/setter \n  // usage.  Effectively, the user of the element must use the property, not\n  // the getAttribute/setAttribute/removeAttribute DOM API, because the latter\n  // calls don't result in the getter/setter being called (so you have to use\n  // the getter/setter directly)\n  get alt() {\n    return this.hasAttribute('alt') ?  this.getAttribute('alt') : \"\";\n  }\n  set alt(value) {\n    this.setAttribute('controls', value);\n  }\n  get coords() {\n    return this.hasAttribute('coords') ? this.getAttribute('coords') : \"\";\n  }\n  set coords(coordinates) {\n    // what to do.  Probably replace the feature with a new one, without changing \n    // anything else...\n  }\n  get href() {\n    return this.hasAttribute('href') ?  this.getAttribute('href') : \"\";\n  }\n  set href(url) {\n    this.href = url;\n  }\n  get shape() {\n    return this.hasAttribute('shape') ?  this.getAttribute('shape') : \"default\";\n  }\n  set shape(shape) {\n    shape = shape.toLowerCase();\n    var re = /default|circle|rect|poly/;\n    if (shape.search(re)) {\n      this.shape = shape;\n    }\n  }\n  get rel() {\n    return this.hasAttribute('rel') ?  this.getAttribute('rel') : \"\";\n  }\n  set rel(rel) {\n    this.rel = rel;\n  }\n  get type() {\n    return this.hasAttribute('type') ?  this.getAttribute('type') : \"\";\n  }\n  set type(type) {\n    this.type = type;\n  }\n  get target() {\n    return this.hasAttribute('target') ?  this.getAttribute('target') : \"\";\n  }\n  constructor() {\n    // Always call super first in constructor\n    super();\n  }\n  attributeChangedCallback(name, oldValue, newValue) {\n    \n  }\n  connectedCallback() {\n    // if the map has been attached, set this layer up wrt Leaflet map\n    if (this.parentElement._map) {\n        this._attachedToMap();\n    }\n  }\n  _attachedToMap() {\n    // need the map to convert container points to LatLngs\n    this._map = this.parentElement._map;\n    var map = this.parentElement._map;\n\n    // don't go through this if already done\n    if (!this._feature) {\n      // Scale this.coords if the this._map.poster exists because\n      // the img might have been scaled by CSS.\n      // compute the style properties to be applied to the feature\n      var options = this._styleToPathOptions(window.getComputedStyle(this)),\n          points = this.coords ? this._coordsToArray(this.coords): null;\n      // scale points if the poster exists because responsive areas\n      if (points && this.parentElement.poster) {\n        var worig = this.parentElement.poster.width, \n            wresp = this.parentElement.width, \n            wadjstmnt = (worig - wresp)/2,\n            horig = this.parentElement.poster.height, \n            hresp = this.parentElement.height, \n            hadjstmnt = (horig - hresp)/2;\n        for (var i = 0; i< points.length;i++) {\n          points[i][0] = points[i][0] - wadjstmnt;\n          points[i][1] = points[i][1] - hadjstmnt;\n        }\n      }\n\n      if (this.shape === 'circle') {\n        var pixelRadius = parseInt(this.coords.split(\",\")[2]), \n            pointOnCirc = L.point(points[0]).add(L.point(0,pixelRadius)),\n            latLngOnCirc = map.containerPointToLatLng(pointOnCirc),\n            latLngCenter = map.containerPointToLatLng(points[0]),\n            radiusInMeters = map.distance(latLngCenter, latLngOnCirc);\n        this._feature = L.circle(latLngCenter, radiusInMeters, options).addTo(map);\n      } else if (!this.shape || this.shape === 'rect') {\n        var bounds = L.latLngBounds(map.containerPointToLatLng(points[0]), map.containerPointToLatLng(points[1]));\n        this._feature = L.rectangle(bounds, options).addTo(map);\n      } else if (this.shape === 'poly') {\n        this._feature = L.polygon(this._pointsToLatLngs(points),options).addTo(map);\n      } else {\n        // whole initial area of map is a hyperlink\n        this._feature = L.rectangle(map.getBounds(),options).addTo(map);\n      }\n      if (this.alt) {\n        // other Leaflet features are implemented via SVG.  SVG displays tooltips\n        // based on the <svg:title> graphics child element.\n        var title = L.SVG.create('title'),\n            titleText = document.createTextNode(this.alt);\n            title.appendChild(titleText);\n            this._feature._path.appendChild(title);\n      }\n      if (this.href) {\n        // conditionally act on click on an area link.  If no link it should be an\n        // inert area, but Leaflet doesn't quite support this.  For a full\n        // implementation, we could actually use an image map replete with area\n        // children which would provide the linking / cursor change behaviours\n        // that are familiar to HTML authors versed in image maps.\n        this._feature.on('click', function() {if (this.href) {window.open(this.href);}}, this);\n      }\n    }\n  }  \n  disconnectedCallback() {\n    this._map.removeLayer(this._feature);\n    delete this._feature;\n  }\n  _coordsToArray(containerPoints) {\n    // returns an array of arrays of coordinate pairs coordsToArray(\"1,2,3,4\") -> [[1,2],[3,4]]\n    for (var i=1, points = [], coords = containerPoints.split(\",\");i<coords.length;i+=2) {\n      points.push([parseInt(coords[i-1]),parseInt(coords[i])]);\n    }\n    return points;\n  }\n  _pointsToLatLngs(points) {\n    // points should be an array of nested container coordinates [[x1,y1],[x2,y2](,[xN,yN])]\n    var latLngArray = [];\n    if (this._map) {\n      for (var i=0,map = this._map;i<points.length;i++) {\n        latLngArray.push(map.containerPointToLatLng(points[i]));\n      }\n    }\n    return latLngArray;\n  }\n  _styleToPathOptions(style) {\n    var options = {};\n    if(style.stroke !== 'none') {\n      options.stroke = true;\n      options.color = style.stroke;\n      options.opacity = style.strokeOpacity;\n      options.weight = parseInt(style.strokeWidth);\n      options.dashArray = style.strokeDasharray;\n      options.lineCap = style.strokeLinecap;\n      options.lineJoin = style.strokeLinejoin;\n    } else {\n      options.stroke = false;\n    }\n    if (style.fill !== 'none') {\n      options.fill = true;\n      options.fillColor = style.fill;\n      options.fillOpacity = style.fillOpacity;\n      options.fillRule = style.fillRule;\n    } else {\n      options.fill = false;\n    }\n    return options;\n  }\n}\n"],"names":["MapArea","HTMLAreaElement","observedAttributes","alt","this","hasAttribute","getAttribute","value","setAttribute","coords","coordinates","href","url","shape","toLowerCase","search","rel","type","target","constructor","super","attributeChangedCallback","name","oldValue","newValue","connectedCallback","parentElement","_map","_attachedToMap","map","_feature","latLngCenter","bounds","options","_styleToPathOptions","window","getComputedStyle","points","_coordsToArray","poster","wadjstmnt","width","hadjstmnt","height","i","length","pixelRadius","parseInt","split","pointOnCirc","L","point","add","latLngOnCirc","containerPointToLatLng","radiusInMeters","distance","circle","addTo","polygon","_pointsToLatLngs","rectangle","getBounds","latLngBounds","title","SVG","create","titleText","document","createTextNode","appendChild","_path","on","open","disconnectedCallback","removeLayer","containerPoints","push","latLngArray","style","stroke","color","opacity","strokeOpacity","weight","strokeWidth","dashArray","strokeDasharray","lineCap","strokeLinecap","lineJoin","strokeLinejoin","fill","fillColor","fillOpacity","fillRule"],"mappings":"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"}