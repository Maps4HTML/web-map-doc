/*! @maps4html/web-map-custom-element 26-04-2023 */

class MapFeature extends HTMLElement{static get observedAttributes(){return["zoom","onfocus","onclick","onblur"]}get zoom(){return+(this.hasAttribute("zoom")?this.getAttribute("zoom"):0)}set zoom(t){t=parseInt(t,10);!isNaN(t)&&t>=this.min&&t<=this.max&&this.setAttribute("zoom",t)}get min(){return+(this.hasAttribute("min")?this.getAttribute("min"):this._layer._layerEl.extent.zoom.minZoom)}set min(t){t=parseInt(t,10);isNaN(t)||(t>=this._layer._layerEl.extent.zoom.minZoom&&t<=this._layer._layerEl.extent.zoom.maxZoom?this.setAttribute("min",t):this.setAttribute("min",this._layer._layerEl.extent.zoom.minZoom))}get max(){return+(this.hasAttribute("max")?this.getAttribute("max"):this._layer._layerEl.extent.zoom.maxZoom)}set max(t){t=parseInt(t,10);isNaN(t)||(t>=this._layer._layerEl.extent.minZoom&&t<=this._layer._layerEl.extent.zoom.maxZoom?this.setAttribute("max",t):this.setAttribute("max",this._layer._layerEl.extent.zoom.maxZoom))}get extent(){if(this.isConnected)return this._getFeatureExtent||(this._getFeatureExtent=this._memoizeExtent()),this._getFeatureExtent()}attributeChangedCallback(t,r,e){switch(t){case"zoom":if(r!==e&&this._layer){let t=this._layer,e=t._layerEl,o=t._mapmlvectors;var i;o?._staticFeature&&(this._removeInFeatureList(r),i=this._getNativeZoomAndCS(t._content),o.zoomBounds=o._getZoomBounds(e.shadowRoot||e,i.zoom)),this._removeFeature(),this._updateFeature()}break;case"onfocus":case"onclick":case"onblur":if(this._groupEl){this._groupEl[t]=this[t];break}}}constructor(){super()}connectedCallback(){this.parentNode.nodeType!==document.DOCUMENT_FRAGMENT_NODE&&"layer-"!==this.parentNode.nodeName.toLowerCase()||this.parentNode.nodeType===document.DOCUMENT_FRAGMENT_NODE&&this.parentNode.host.hasAttribute("data-moving")||"layer-"===this.parentNode.nodeName.toLowerCase()&&this.parentNode.hasAttribute("data-moving")||(this._addFeature(),this._observer=new MutationObserver(t=>{for(var e of t){if("attributes"===e.type&&e.target===this)return;this._removeFeature(),this._updateFeature()}}),this._observer.observe(this,{childList:!0,subtree:!0,attributes:!0,attributeOldValue:!0,characterData:!0}))}disconnectedCallback(){this._layer._layerEl.hasAttribute("data-moving")||(this._removeFeature(),this._observer.disconnect())}_removeFeature(){if(this._groupEl?.isConnected&&this._groupEl.remove(),this._featureGroup?._map){this._featureGroup._map.removeLayer(this._featureGroup);let t=this._layer._mapmlvectors;var e;t&&(t._staticFeature&&(t._features[this.zoom]&&this._removeInFeatureList(this.zoom),e=this._layer.shadowRoot||this._layer._layerEl,t.zoomBounds=t._getZoomBounds(e,this._getNativeZoomAndCS().zoom)),t.options.properties=null,delete t._layers[this._featureGroup._leaflet_id])}delete this._featureGroup,delete this._groupEl,this._getFeatureExtent&&delete this._getFeatureExtent}_addFeature(){this._layer=this.parentNode._layer||this.parentNode.host._layer,this._layer._map?this._map=this._layer._map:this._layer.once("add",function(){this._map=this._layer._map},this),this._layer._mapmlvectors?this._featureGroup?this._setUpEvents():this._updateFeature():this._layer.once("add",this._setUpEvents,this)}_updateFeature(){let t=this._layer._mapmlvectors;var e;t&&(e=this._getNativeZoomAndCS(this._layer._content),this._featureGroup=t.addData(this,e.cs,e.zoom),t._layers[this._featureGroup._leaflet_id]=this._featureGroup,this._groupEl=this._featureGroup.options.group,t._staticFeature&&(e=this._layer.shadowRoot||this._layer._layerEl,t.zoomBounds=t._getZoomBounds(e,this._getNativeZoomAndCS().zoom),t._resetFeatures(),this._map._addZoomLimit(t),L.extend(t.options,t.zoomBounds)),this._setUpEvents())}_setUpEvents(){["click","focus","blur"].forEach(o=>{this["on"+o]&&"function"==typeof this["on"+o]&&(this._groupEl["on"+o]=this["on"+o]),this._groupEl.addEventListener(o,t=>{var e=this["on"+o];this["on"+o]=null,"click"===o?this.dispatchEvent(new MouseEvent(o,{...t.options})):this.dispatchEvent(new FocusEvent(o,{...t.options})),e&&(this["on"+o]=e)})})}_getNativeZoomAndCS(t){var s;if(!t||"LAYER-"===t.nodeName.toUpperCase()){let t=this._layer._layerEl,e=t.querySelectorAll("map-meta[name=zoom]"),o=e?.length;s=o?+e[o-1].getAttribute("content")?.split(",").find(t=>t.includes("value"))?.split("=")[1]:0;let r=t.querySelectorAll("map-meta[name=cs]"),i=r?.length;return{zoom:s,cs:i?r[i-1].getAttribute("content"):"pcrs"}}if(t.nodeType===Node.DOCUMENT_NODE)return this._layer._mapmlvectors._getNativeVariables(t)}_memoizeExtent(){let h;return function(){if(h&&this._getFeatureExtent)return h;{let i=this._map,t=this.querySelector("map-geometry"),e=this._getNativeZoomAndCS(this._layer._content),o=t.getAttribute("cs")||e.cs,r=this.zoom||e.zoom,s=t.querySelectorAll("map-point, map-linestring, map-polygon, map-multipoint, map-multilinestring"),a=[1/0,1/0,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];for(var l of s){var u=l.querySelectorAll("map-coordinates");for(let t=0;t<u.length;++t)a=function(t,e,o){var r=e.innerHTML.trim().replace(/<[^>]+>/g,"").replace(/\s+/g," ").split(/[<>\ ]/g);switch(t.tagName){case"MAP-POINT":o=M._updateExtent(o,+r[0],+r[1]);break;case"MAP-LINESTRING":case"MAP-POLYGON":case"MAP-MULTIPOINT":case"MAP-MULTILINESTRING":for(let t=0;t<r.length;t+=2)o=M._updateExtent(o,+r[t],+r[t+1])}return o}(l,u[t],a)}var m=L.point(a[0],a[1]),p=L.point(a[2],a[3]);let n=M.boundsToPCRSBounds(L.bounds(m,p),r,i.options.projection,o);if(1===s.length&&"MAP-POINT"===s[0].tagName.toUpperCase()){let t=i.options.projection,e=this.hasAttribute("max")?+this.getAttribute("max"):M[t].options.resolutions.length-1,o=M[t].options.crs.tile.bounds.getCenter(),r=M[t].transformation.transform(n.min,M[t].scale(+this.zoom||e));n=M.pixelToPCRSBounds(L.bounds(r.subtract(o),r.add(o)),this.zoom||e,t)}p=M._convertAndFormatPCRS(n,i);return h=p}}}_removeInFeatureList(e){let o=this._layer._mapmlvectors;for(let t=0;t<o._features[e].length;++t)if(o._features[e][t]._leaflet_id===this._featureGroup._leaflet_id){o._features[e].splice(t,1);break}}mapml2geojson(t){t=Object.assign({},{propertyFunction:null,transform:!0},t);let e={type:"Feature",properties:{},geometry:{}},o=this.querySelector("map-properties");o?"function"==typeof t.propertyFunction?e.properties=t.propertyFunction(o):o.querySelector("table")?(a=o.querySelector("table").cloneNode(!0),e.properties=M._table2properties(a)):e.properties={prop0:o.innerHTML.replace(/(<([^>]+)>)/gi,"").replace(/\s/g,"")}:e.properties=null;let r=null,i=null;t.transform&&(r=new proj4.Proj(this._map.options.crs.code),i=new proj4.Proj("EPSG:4326"),"EPSG:3857"!==this._map.options.crs.code&&"EPSG:4326"!==this._map.options.crs.code||(t.transform=!1));var s=this.querySelector("map-geometry").querySelector("map-geometrycollection"),a=this.querySelector("map-geometry").querySelectorAll("map-point, map-polygon, map-linestring, map-multipoint, map-multipolygon, map-multilinestring");if(s){e.geometry.type="GeometryCollection",e.geometry.geometries=[];for(var n of a)e.geometry.geometries.push(M._geometry2geojson(n,r,i,t.transform))}else e.geometry=M._geometry2geojson(a[0],r,i,t.transform);return e}click(t){let e=this._groupEl,o=e.getBoundingClientRect();if(t=t||new MouseEvent("click",{clientX:o.x+o.width/2,clientY:o.y+o.height/2,button:0}),"function"==typeof this.onclick)this.onclick.call(this,t);else{var r=this.querySelector("map-properties");if("link"===e.getAttribute("role"))for(var i of e.children)i.mousedown.call(this._featureGroup,t),i.mouseup.call(this._featureGroup,t);if(r&&this.isConnected){let t=this._featureGroup,e=t._layers;for(var s in e)e[s].isPopupOpen()&&e[s].closePopup();t.isPopupOpen()?t.closePopup():t.openPopup()}}}focus(t,e){let o=this._groupEl;"function"==typeof this.onfocus?this.onfocus.call(this,t):o.focus(e)}blur(t){"function"==typeof this.onblur?this.onblur.call(this,t):document.activeElement.shadowRoot?.activeElement!==this._groupEl&&document.activeElement.shadowRoot?.activeElement.parentNode!==this._groupEl||(this._groupEl.blur(),this._map._container.focus())}zoomTo(){let t=this.extent,e=this._map,o=t.topLeft.pcrs,r=t.bottomRight.pcrs,i=L.bounds(L.point(o.horizontal,o.vertical),L.point(r.horizontal,r.vertical)),s=e.options.crs.unproject(i.getCenter(!0));var a=e.options.projection,n=this._layer._layerEl.extent.zoom,l=n.minZoom||0,a=n.maxZoom||M[a].options.resolutions.length-1;let u;this.hasAttribute("zoom")?u=this.zoom:(u=M.getMaxZoom(i,e,l,a),this.max<u?u=this.max:this.min>u&&(u=this.min)),u<l?u=l:u>a&&(u=a),e.setView(s,u,{animate:!1})}}export{MapFeature};
//# sourceMappingURL=map-feature.js.map